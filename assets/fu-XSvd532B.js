const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/dev-B6DQPL-N.js","assets/modulepreload-polyfill-B5Qt9EMX.js","assets/three.module-CAwrvc93.js"])))=>i.map(i=>d[i]);
import"./modulepreload-polyfill-B5Qt9EMX.js";import{O as rt,aj as ct,E as dt,ai as ht,az as ft,m as Ue,ay as ut,al as gt,V as mt,aA as pt,aB as Ge,aC as xt,I as wt,i as ue}from"./three.module-CAwrvc93.js";import{createClient as yt}from"https://esm.sh/@supabase/supabase-js@2";const Mt="modulepreload",bt=function(s){return"/"+s},Xe={},vt=function(t,a,r){let n=Promise.resolve();if(a&&a.length>0){document.getElementsByTagName("link");const o=document.querySelector("meta[property=csp-nonce]"),l=(o==null?void 0:o.nonce)||(o==null?void 0:o.getAttribute("nonce"));n=Promise.allSettled(a.map(i=>{if(i=bt(i),i in Xe)return;Xe[i]=!0;const f=i.endsWith(".css"),h=f?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${i}"]${h}`))return;const d=document.createElement("link");if(d.rel=f?"stylesheet":Mt,f||(d.as="script"),d.crossOrigin="",d.href=i,l&&d.setAttribute("nonce",l),document.head.appendChild(d),f)return new Promise((m,x)=>{d.addEventListener("load",m),d.addEventListener("error",()=>x(new Error(`Unable to preload CSS for ${i}`)))})}))}function c(o){const l=new Event("vite:preloadError",{cancelable:!0});if(l.payload=o,window.dispatchEvent(l),!l.defaultPrevented)throw o}return n.then(o=>{for(const l of o||[])l.status==="rejected"&&c(l.reason);return t().catch(c)})},g={bg:"#990000",glowRed:"#FF2D2D",glowGold:"#FFD700",glowGreen:"#00FF9F",scatterDur:450,scrambleDur:900,convergeDur:450,settleDur:250,fuExplodeDelay:2,fuRiseDuration:.8,fuShrinkDuration:.8,fuShrinkEndScale:.18,fuCameraPullbackDuration:.45,fuCameraReturnDuration:.7,shellRiseDuration:2.5},he=[" ","·","一","人","十","大","吉","平","安","和","春","利","兴","旺","发","金","贵","富","财","寿","禄","喜","龙","凤","福"],z="福禄寿喜财富贵发金玉宝余丰盛利旺隆昌兴进安康宁泰和平顺健乐欢庆禧祺嘉春德善仁义忠信孝慧恩爱合圆满美馨雅吉祥瑞如意祝运龙凤麟鹤华成升登高",Fe={一:{phrase:"一帆风顺",english:"Smooth sailing in all endeavors"},人:{phrase:"人寿年丰",english:"Long life and abundant harvests"},十:{phrase:"十全十美",english:"Perfection in every way"},大:{phrase:"大吉大利",english:"Great luck and great profit"},吉:{phrase:"吉祥如意",english:"Good fortune as you wish"},平:{phrase:"四季平安",english:"Peace through all four seasons"},安:{phrase:"岁岁平安",english:"Peace and safety year after year"},和:{phrase:"和气生财",english:"Harmony brings prosperity"},春:{phrase:"春风得意",english:"Success on the spring breeze"},利:{phrase:"开岁大利",english:"Great profit in the new year"},兴:{phrase:"兴旺发达",english:"Flourishing and thriving"},旺:{phrase:"人丁兴旺",english:"A growing and prosperous family"},发:{phrase:"恭喜发财",english:"Wishing you great prosperity"},金:{phrase:"金玉满堂",english:"Gold and jade fill the hall"},贵:{phrase:"荣华富贵",english:"Glory, splendor, and riches"},富:{phrase:"富贵有余",english:"Wealth and abundance to spare"},财:{phrase:"财源广进",english:"Wealth flowing from all directions"},寿:{phrase:"福寿双全",english:"Both blessings and longevity"},禄:{phrase:"高官厚禄",english:"High rank and generous reward"},喜:{phrase:"双喜临门",english:"Double happiness at the door"},龙:{phrase:"龙马精神",english:"The vigor of dragons and horses"},凤:{phrase:"龙凤呈祥",english:"Dragon and phoenix bring fortune"},福:{phrase:"福星高照",english:"The star of fortune shines bright"}},R=['"Zhi Mang Xing"','"Liu Jian Mao Cao"','"Ma Shan Zheng"','"TsangerZhoukeZhengdabangshu"','"hongleixingshu"','"qiantubifengshouxieti"','"峄山碑篆体"'],Ye=[{chars:"福禄寿喜财",r:255,g:45,b:45},{chars:"财富贵发金玉宝余丰盛利旺",r:255,g:215,b:0},{chars:"安康宁泰和平顺健",r:0,g:255,b:159},{chars:"喜乐欢庆禧祺嘉春",r:255,g:120,b:80},{chars:"德善仁义忠信孝慧恩",r:255,g:200,b:50},{chars:"爱合圆满美馨雅",r:255,g:130,b:180},{chars:"吉祥瑞如意祝运",r:180,g:255,b:80},{chars:"龙凤麟鹤华",r:255,g:180,b:50},{chars:"成升登高",r:80,g:220,b:255}],ie=500,k=20,oe=20,I=64,e={canvas:null,ctx:null,cellSize:0,cols:0,rows:0,gridW:0,gridH:0,offsetX:0,offsetY:0,dpr:Math.min(window.devicePixelRatio||1,2),grid:[],glRenderer:null,glScene:null,glCamera:null,particlesMesh:null,charToUV:{},globalTime:0,stateTime:0,stateStartGlobal:0,state:"arrival",drawToFortuneSeed:null,fuShape:[],dajiShape:[],fontsReady:!1,chosenFont:R[Math.floor(Math.random()*R.length)],envelopeManager:null};function w(s,t,a){return s+(t-s)*a}function E(s){return s<.5?2*s*s:-1+(4-2*s)*s}function $e(s,t,a,r){const n=r/(r+a);return{screenX:s*n+window.innerWidth/2,screenY:t*n+window.innerHeight/2,scale:n}}function Ke(s,t){return{x:(s-e.cols/2)*e.cellSize,y:(t-e.rows/2)*e.cellSize}}function He(s,t,a){const r=document.createElement("canvas"),n=r.getContext("2d"),c=[...s].length,o=t*c,l=t;r.width=o,r.height=l,n.fillStyle="#000",n.fillRect(0,0,o,l),n.fillStyle="#fff",n.textAlign="center",n.textBaseline="middle";const i=a||'"SimSun", "STSong", "Songti SC", "Noto Serif SC", serif';n.font=`bold ${Math.floor(t*.85)}px ${i}`,n.fillText(s,o/2,l/2);const h=n.getImageData(0,0,o,l).data,d=[],m=c>1?2:1;for(let x=0;x<l;x+=m)for(let u=0;u<o;u+=m){const M=(x*o+u)*4,y=h[M]/255;y>.1&&d.push({nx:u/o*2-1,ny:x/l*2-1,brightness:y,aspect:c})}return d}function De(s){const t=Math.floor(s*(he.length-1));return he[Math.max(0,Math.min(t,he.length-1))]}function Pe(s){const a=Math.floor(45+s*170),r=Math.floor(45-s*45);return{r:255,g:a,b:r}}function Tt(){e.grid=new Array(e.rows*e.cols).fill(null)}function St(s,t,a,r,n,c,o,l){if(s<0||s>=e.cols||t<0||t>=e.rows)return;const i=t*e.cols+s,f=e.grid[i];f&&f.depth<=a||(e.grid[i]={char:r,r:n,g:c,b:o,alpha:l,depth:a})}function Qe(){e.dpr=Math.min(window.devicePixelRatio||1,2),e.canvas.width=window.innerWidth*e.dpr,e.canvas.height=window.innerHeight*e.dpr,e.canvas.style.width=window.innerWidth+"px",e.canvas.style.height=window.innerHeight+"px";const s=Math.min(window.innerWidth,window.innerHeight);if(e.cellSize=Math.max(10,Math.floor(s*.028)),e.cols=Math.floor(window.innerWidth/e.cellSize),e.rows=Math.floor(window.innerHeight/e.cellSize),e.gridW=e.cols*e.cellSize,e.gridH=e.rows*e.cellSize,e.offsetX=(window.innerWidth-e.gridW)/2,e.offsetY=(window.innerHeight-e.gridH)/2,e.glRenderer){e.glRenderer.setSize(window.innerWidth,window.innerHeight),e.glRenderer.setPixelRatio(e.dpr);const t=2*Math.atan(window.innerHeight/(2*ie))*(180/Math.PI);e.glCamera.fov=t,e.glCamera.aspect=window.innerWidth/window.innerHeight,e.glCamera.updateProjectionMatrix()}}function Ct(){e.ctx.save(),e.ctx.globalAlpha=.03,e.ctx.fillStyle="#fff";for(let s=0;s<e.canvas.height;s+=4*e.dpr)e.ctx.fillRect(0,s,e.canvas.width,1*e.dpr);e.ctx.restore()}function At(){const{ctx:s,dpr:t,cols:a,rows:r,grid:n,cellSize:c,offsetX:o,offsetY:l}=e;s.save(),s.scale(t,t),s.fillStyle=g.bg,s.fillRect(0,0,window.innerWidth,window.innerHeight);const i=c;s.font=`${i}px ${e.chosenFont}, "Courier New", "SF Mono", monospace`,s.textAlign="center",s.textBaseline="middle";for(let f=0;f<r;f++)for(let h=0;h<a;h++){const d=n[f*a+h];if(!d)continue;const m=o+h*c+c/2,x=l+f*c+c/2;d.alpha>.3?(s.shadowColor=`rgba(${d.r}, ${d.g}, ${d.b}, ${d.alpha*.6})`,s.shadowBlur=c*d.alpha*1.2):(s.shadowColor="transparent",s.shadowBlur=0),s.fillStyle=`rgba(${d.r}, ${d.g}, ${d.b}, ${d.alpha})`,s.fillText(d.char,m,x)}s.shadowBlur=0,s.shadowColor="transparent",s.restore(),Ct()}const et=[];function Et(){for(let s=0;s<40;s++)et.push({col:Math.random()*e.cols,row:Math.random()*e.rows,vx:(Math.random()-.5)*.02,vy:(Math.random()-.5)*.02,char:z[Math.floor(Math.random()*z.length)],alpha:.03+Math.random()*.08,phase:Math.random()*Math.PI*2,changeTimer:Math.random()*200})}function Ie(s){for(const t of et){t.col+=t.vx,t.row+=t.vy,t.changeTimer--,t.col<0&&(t.col+=e.cols),t.col>=e.cols&&(t.col-=e.cols),t.row<0&&(t.row+=e.rows),t.row>=e.rows&&(t.row-=e.rows),t.changeTimer<=0&&(t.char=z[Math.floor(Math.random()*z.length)],t.changeTimer=100+Math.random()*200);const a=Math.floor(t.col),r=Math.floor(t.row),n=t.alpha+Math.sin(t.phase+s*1.5)*.02;St(a,r,999,t.char,255,215,0,Math.max(.01,n))}}const _t=`// Particle vertex shader — billboarded instanced quads
// Uses instanceMatrix from Three.js InstancedMesh (set via setMatrixAt)

attribute vec3 instanceColor;     // RGB normalized 0-1
attribute float instanceAlpha;
attribute vec2 instanceUV;        // atlas cell UV offset
attribute float instanceScale;    // quad size in world units

uniform vec2 cellSize;            // UV size of one atlas cell (1/cols, 1/rows)

varying vec2 vUv;
varying vec3 vColor;
varying float vAlpha;

void main() {
    // Extract world position from instanceMatrix (translation column)
    vec4 worldPos = instanceMatrix * vec4(0.0, 0.0, 0.0, 1.0);

    // Transform to view space
    vec4 mvPosition = modelViewMatrix * worldPos;

    // Billboard: expand unit quad in view space (always faces camera)
    mvPosition.xy += position.xy * instanceScale;

    gl_Position = projectionMatrix * mvPosition;

    // Map quad UV (0..1) into this character's atlas cell
    vUv = instanceUV + uv * cellSize;
    vColor = instanceColor;
    vAlpha = instanceAlpha;
}
`,zt=`// Particle fragment shader — samples character atlas, applies color tint
// Atlas: white chars with baked glow on BLACK background (R channel = intensity)
// Output: premultiplied alpha for additive blending

uniform sampler2D atlas;

varying vec2 vUv;
varying vec3 vColor;
varying float vAlpha;

void main() {
    float raw = texture2D(atlas, vUv).r;
    float intensity = pow(raw, 0.75); // Lift dim glow fringe for softer halo
    float alpha = intensity * vAlpha;
    if (alpha < 0.01) discard;

    // Premultiplied color for additive blending (src + dst)
    gl_FragColor = vec4(vColor * alpha, alpha);
}
`,A=new rt;function It(){e.glRenderer=new ct({alpha:!0,antialias:!1}),e.glRenderer.setSize(window.innerWidth,window.innerHeight),e.glRenderer.setPixelRatio(e.dpr);const s=2*Math.atan(window.innerHeight/(2*ie))*(180/Math.PI);e.glCamera=new dt(s,window.innerWidth/window.innerHeight,1,3e3),e.glCamera.position.set(0,0,ie),e.glCamera.lookAt(0,0,0),e.glScene=new ht;const t=document.createElement("canvas");t.width=k*I,t.height=oe*I;const a=t.getContext("2d");a.fillStyle="#000",a.fillRect(0,0,t.width,t.height);const r=new Set([...he,...z.split(""),...Object.keys(Fe),"·"]);a.font=`bold ${Math.floor(I*.7)}px "Courier New", "SF Mono", monospace`,a.textAlign="center",a.textBaseline="middle",a.fillStyle="#FFFFFF",a.shadowColor="white",a.shadowBlur=I*.12;let n=0;r.forEach(u=>{if(n>=k*oe)return;const M=n%k,y=Math.floor(n/k),p=M*I+I/2,T=y*I+I/2;a.fillText(u,p,T),e.charToUV[u]={u:M/k,v:1-(y+1)/oe},n++});const c=he.filter(u=>u!==" ");for(let u=0;u<R.length;u++){a.font=`bold ${Math.floor(I*.7)}px ${R[u]}, "Courier New", monospace`;for(const M of c){if(n>=k*oe)break;const y=n%k,p=Math.floor(n/k),T=y*I+I/2,S=p*I+I/2;a.fillText(M,T,S),e.charToUV[M+"|"+u]={u:y/k,v:1-(p+1)/oe},n++}}const o=new ft(t);o.magFilter=Ue,o.minFilter=Ue;const l=4e3,i=new ut(1,1),f=new gt({uniforms:{atlas:{value:o},cellSize:{value:new mt(1/k,1/oe)}},vertexShader:_t,fragmentShader:zt,transparent:!0,blending:pt,blendSrc:Ge,blendDst:Ge,blendEquation:xt,depthWrite:!1,depthTest:!1});e.particlesMesh=new wt(i,f,l);const h=new Float32Array(l*3),d=new Float32Array(l),m=new Float32Array(l*2),x=new Float32Array(l);e.particlesMesh.geometry.setAttribute("instanceColor",new ue(h,3)),e.particlesMesh.geometry.setAttribute("instanceAlpha",new ue(d,1)),e.particlesMesh.geometry.setAttribute("instanceUV",new ue(m,2)),e.particlesMesh.geometry.setAttribute("instanceScale",new ue(x,1)),e.particlesMesh.frustumCulled=!1,e.glScene.add(e.particlesMesh)}function Re(){!e.glRenderer||!e.glScene||!e.glCamera||(e.glRenderer.render(e.glScene,e.glCamera),e.ctx.save(),e.ctx.setTransform(1,0,0,1,0,0),e.ctx.globalCompositeOperation="lighter",e.ctx.drawImage(e.glRenderer.domElement,0,0),e.ctx.restore())}function Bt(s){if(!e.particlesMesh)return;if(!s.length){e.particlesMesh.count=0;return}const t=e.particlesMesh.geometry.attributes.instanceColor,a=e.particlesMesh.geometry.attributes.instanceAlpha,r=e.particlesMesh.geometry.attributes.instanceUV,n=e.particlesMesh.geometry.attributes.instanceScale,c=e.particlesMesh.geometry.getAttribute("instanceColor").count,o=Math.min(s.length,c);for(let l=0;l<o;l++){const i=s[l];A.position.set(i.x,-i.y,-i.z),A.updateMatrix(),e.particlesMesh.setMatrixAt(l,A.matrix),t.setXYZ(l,i.r/255,i.g/255,i.b/255),a.setX(l,i.alpha);const f=i.fontIdx!=null&&e.charToUV[i.char+"|"+i.fontIdx]||e.charToUV[i.char];f&&r.setXY(l,f.u,f.v),n.setX(l,e.cellSize*(i.size||1))}e.particlesMesh.count=o,e.particlesMesh.instanceMatrix.needsUpdate=!0,t.needsUpdate=!0,a.needsUpdate=!0,r.needsUpdate=!0,n.needsUpdate=!0,Re()}function Wt(s){e.ctx.save(),e.ctx.scale(e.dpr,e.dpr);const a=Math.min(window.innerWidth,window.innerHeight)*.55,r=window.innerWidth/2,n=window.innerHeight/2;e.ctx.textAlign="center",e.ctx.textBaseline="middle",e.ctx.font=`${a}px ${e.chosenFont}, serif`,e.ctx.globalAlpha=s*.3,e.ctx.shadowColor=g.glowGold,e.ctx.shadowBlur=a*.15,e.ctx.fillStyle=g.glowGold,e.ctx.fillText("福",r,n),e.ctx.globalAlpha=s,e.ctx.shadowColor=g.glowGold,e.ctx.shadowBlur=a*.06,e.ctx.fillStyle=g.glowGold,e.ctx.fillText("福",r,n),e.ctx.shadowBlur=0,e.ctx.restore()}function B(s,t,a,r,n,c){e.ctx.save(),e.ctx.scale(e.dpr,e.dpr);const o=n||Math.max(12,e.cellSize*1.2),l=c||'"Courier New", "SF Mono", monospace';e.ctx.font=`${o}px ${l}`,e.ctx.textAlign="center",e.ctx.textBaseline="middle",e.ctx.fillStyle=a||g.glowGreen,e.ctx.globalAlpha=r??.6,e.ctx.shadowColor=a||g.glowGreen,e.ctx.shadowBlur=o*.4,e.ctx.fillText(s,window.innerWidth/2,window.innerHeight*t),e.ctx.shadowBlur=0,e.ctx.restore()}let xe=0,ve=null,Be=0;const Ft=4.5;function ge(){return R[xe]}function Dt(){return ve}function Pt(){ve=null}function we(s){const t=R[xe];let a;do a=Math.floor(Math.random()*R.length);while(a===xe&&R.length>1);xe=a,ve={oldFont:t,startTime:e.globalTime},Be=e.globalTime}function Rt(){!ve&&e.stateTime>6&&e.globalTime-Be>Ft&&(Be=e.globalTime,we())}let G=[],ae=0,V=!1,te=-1;function Ne(s){if(G=[],te=-1,fe(),Array.isArray(s)&&s.length>0){G=s.map(r=>({...r})),V=!0,ae=e.globalTime;return}if(!e.fontsReady)return;const t=Math.min(e.cols,e.rows)*.4*e.cellSize,a=t*.4;for(const r of e.dajiShape){const n=Math.min(1,r.brightness+.08),c=De(n);if(c===" ")continue;const o=Pe(n);G.push({baseX:r.nx*t*.5*r.aspect,baseY:r.ny*t*.5,origZ:(Math.random()-.5)*a,char:c,fontIdx:Math.random()<.7?Math.floor(Math.random()*R.length):null,r:o.r,g:o.g,b:o.b,alpha:.3+n*.7,lum:n,phase:Math.random()*Math.PI*2})}ae=e.globalTime}function Lt(s){if(!e.particlesMesh)return 0;if(!G.length)return e.particlesMesh.count=0,0;const t=Math.min(e.cols,e.rows)*.4*e.cellSize,a=Math.min(1,(e.globalTime-ae)/1.2),r=V?1:E(a),n=V?Math.min(1,(e.globalTime-ae)/.6):1,c=V?0:.5,o=V?1:Math.min(1,Math.max(0,(e.globalTime-ae-c)/.8)),l=t*.06*o,i=e.particlesMesh.geometry.attributes.instanceColor,f=e.particlesMesh.geometry.attributes.instanceAlpha,h=e.particlesMesh.geometry.attributes.instanceUV,d=e.particlesMesh.geometry.attributes.instanceScale,m=i.count,x=Math.min(G.length,m),u=t*.5,M=Math.sin(e.globalTime*.8)*.3;for(let y=0;y<x;y++){const p=G[y],T=p.origZ*r+Math.sin(e.globalTime*1.5+p.phase)*l,S=y===te,D=S?-80:0;A.position.set(p.baseX,-p.baseY,-(T+D)),A.updateMatrix(),e.particlesMesh.setMatrixAt(y,A.matrix);let N=p.alpha*Math.max(.2,1.25);N=Math.min(.8,N),S&&(N=1);const _=u>0?p.baseY/u:0,b=Math.max(0,Math.min(1,(_+1)*.5)),X=Math.abs(_-M),v=Math.max(0,1-X*3),L=Math.min(255,Math.floor(w(255,180,b)+v*55)),C=Math.min(255,Math.floor(w(225,130,b)+v*40)),J=Math.min(255,Math.floor(w(50,10,b)+v*50)),Y=w(p.r,L,n)/255,j=w(p.g,C,n)/255,K=w(p.b,J,n)/255;i.setXYZ(y,S?1:Y,S?.97:j,S?.86:K),f.setX(y,N);const $=p.fontIdx!=null&&e.charToUV[p.char+"|"+p.fontIdx]||e.charToUV[p.char];$&&h.setXY(y,$.u,$.v);let ce=e.cellSize*1.1;S&&(ce*=2.2),d.setX(y,ce)}return e.particlesMesh.count=x,e.particlesMesh.instanceMatrix.needsUpdate=!0,i.needsUpdate=!0,f.needsUpdate=!0,h.needsUpdate=!0,d.needsUpdate=!0,x}const se=document.createElement("div");Object.assign(se.style,{position:"fixed",pointerEvents:"none",opacity:"0",transition:"opacity 0.2s ease",background:"rgba(10, 10, 10, 0.92)",border:"1px solid rgba(255, 215, 0, 0.4)",borderRadius:"8px",padding:"14px 18px",textAlign:"center",fontFamily:'"Courier New", "SF Mono", monospace',zIndex:"100",backdropFilter:"blur(8px)",WebkitBackdropFilter:"blur(8px)",boxShadow:"0 0 24px rgba(255, 45, 45, 0.15), 0 0 8px rgba(255, 215, 0, 0.1)",maxWidth:"220px",minWidth:"140px"});se.innerHTML='<div id="tt-char" style="font-size:36px;color:#FFD700;margin-bottom:6px;text-shadow:0 0 12px rgba(255,215,0,0.5)"></div><div id="tt-phrase" style="font-size:15px;color:#FF2D2D;margin-bottom:4px"></div><div id="tt-english" style="font-size:11px;color:#FFD700;opacity:0.65"></div>';document.body.appendChild(se);function kt(s,t,a){const r=Fe[s];if(!r){fe();return}document.getElementById("tt-char").textContent=s,document.getElementById("tt-phrase").textContent=r.phrase,document.getElementById("tt-english").textContent=r.english;const n=200,c=110;let o=t-n/2,l=a-c-30;o=Math.max(8,Math.min(window.innerWidth-n-8,o)),l<8&&(l=a+40),se.style.left=o+"px",se.style.top=l+"px",se.style.opacity="1"}function fe(){se.style.opacity="0"}function me(s,t){if(G.length===0){te=-1,fe();return}const a=Math.min(e.cols,e.rows)*.4*e.cellSize,r=Math.min(1,(e.globalTime-ae)/1.2),n=V?1:E(r),c=V?Math.min(1,(e.globalTime-ae)/.6):1,o=a*.06*(V?c:n);let l=-1,i=1/0;for(let h=0;h<G.length;h++){const d=G[h];if(!Fe[d.char])continue;const m=d.origZ*n+Math.sin(e.globalTime*1.5+d.phase)*o,x=$e(d.baseX,d.baseY,m,ie),u=x.screenX-s,M=x.screenY-t,y=u*u+M*M;y<i&&(i=y,l=h)}const f=e.cellSize*2.5;if(i>f*f){te=-1,fe();return}if(l!==te){te=l;const h=G[l],d=h.origZ*n+Math.sin(e.globalTime*1.5+h.phase)*o,m=$e(h.baseX,h.baseY,d,ie);kt(h.char,m.screenX,m.screenY)}}function Te(){te=-1,fe()}const Z=[],O=[],q=[];let ye=0,Le=0;function tt(){const s=Ye[Math.floor(Math.random()*Ye.length)],t=e.cols*(.15+Math.random()*.7),a=t+(Math.random()-.5)*e.cols*.12,r=je(t,e.rows+2),n=je(a,e.rows*(.1+Math.random()*.3)),c=(Math.random()-.5)*e.cellSize*8;Z.push({x:r.x,y:r.y,z:c,startX:r.x,startY:r.y,startZ:c,targetX:n.x,targetY:n.y,targetZ:(Math.random()-.5)*e.cellSize*12,launchTime:e.globalTime,duration:g.shellRiseDuration*(.85+Math.random()*.3),cat:s}),Le++}function je(s,t){return{x:(s-e.cols/2)*e.cellSize,y:(t-e.rows/2)*e.cellSize}}function Ut(s){const t=25+Math.floor(Math.random()*35),{chars:a,r,g:n,b:c}=s.cat;for(let o=0;o<t;o++){const l=Math.PI*2*o/t+(Math.random()-.5)*.4,i=e.cellSize*(.06+Math.random()*.1);q.push({x:s.x,y:s.y,z:s.z,vx:Math.cos(l)*i,vy:Math.sin(l)*i-e.cellSize*.06,vz:(Math.random()-.5)*i*.5,char:a[Math.floor(Math.random()*a.length)],r,g:n,b:c,life:.6+Math.random()*.3,decay:.008+Math.random()*.008,gravity:e.cellSize*(.001+Math.random()*.001),drag:.985,trailSegs:[],lastTrailTime:e.globalTime})}}function nt(){Z.length=0,O.length=0,q.length=0,ye=0,Le=0;for(let s=0;s<2;s++)tt()}function Gt(){ye--,ye<=0&&(tt(),ye=Le<3?40+Math.random()*30:70+Math.random()*80);const s=e.cols*e.cellSize*.5,t=e.rows*e.cellSize*.5;let a=0;for(let l=0;l<Z.length;l++){const i=Z[l],f=(e.globalTime-i.launchTime)/i.duration,h=1-Math.pow(1-Math.min(f,1),2);i.x=w(i.startX,i.targetX,h),i.y=w(i.startY,i.targetY,h),i.z=w(i.startZ,i.targetZ,h);const d=Math.max(1,Math.floor((1-h)*2.8));for(let m=0;m<d;m++)O.push({x:i.x+(Math.random()-.5)*e.cellSize*.35,y:i.y+e.cellSize*(.12+Math.random()*.32),z:i.z+(Math.random()-.5)*e.cellSize*.6,vx:(Math.random()-.5)*e.cellSize*.03,vy:e.cellSize*(.07+Math.random()*.04),vz:(Math.random()-.5)*e.cellSize*.03,char:"·",r:i.cat.r,g:i.cat.g,b:i.cat.b,life:.35+Math.random()*.45,decay:.03+Math.random()*.04});f>=1?Ut(i):Z[a++]=i}Z.length=a;let r=0;for(let l=0;l<O.length;l++){const i=O[l];i.x+=i.vx,i.y+=i.vy,i.z+=i.vz,i.vx*=.95,i.vz*=.95,i.life-=i.decay,i.life>0&&i.y<=t+e.cellSize*3&&(O[r++]=i)}O.length=r;const n=.06,c=14;let o=0;for(let l=0;l<q.length;l++){const i=q[l];i.vx*=i.drag,i.vy*=i.drag,i.vz*=i.drag,i.vy+=i.gravity,i.x+=i.vx,i.y+=i.vy,i.z+=i.vz,i.life-=i.decay,e.globalTime-i.lastTrailTime>=n&&i.life>.05&&(i.trailSegs.push({x:i.x,y:i.y,z:i.z}),i.lastTrailTime=e.globalTime,i.trailSegs.length>c&&i.trailSegs.shift()),i.life>0&&i.y<=t+e.cellSize*6&&i.x>=-s-e.cellSize*8&&i.x<=s+e.cellSize*8&&i.z>=-ie*.9&&i.z<=ie*1.5&&(q[o++]=i)}q.length=o}function Xt(s){if(!e.particlesMesh)return;const t=e.particlesMesh.geometry.attributes.instanceColor,a=e.particlesMesh.geometry.attributes.instanceAlpha,r=e.particlesMesh.geometry.attributes.instanceUV,n=e.particlesMesh.geometry.attributes.instanceScale,c=t.count;let o=s;for(const l of Z){if(o>=c)break;A.position.set(l.x,-l.y,-l.z),A.updateMatrix(),e.particlesMesh.setMatrixAt(o,A.matrix),t.setXYZ(o,l.cat.r/255,l.cat.g/255,l.cat.b/255),a.setX(o,.9);const i=e.charToUV["·"];i&&r.setXY(o,i.u,i.v),n.setX(o,e.cellSize),o++}for(const l of O){if(o>=c)break;A.position.set(l.x,-l.y,-l.z),A.updateMatrix(),e.particlesMesh.setMatrixAt(o,A.matrix),t.setXYZ(o,l.r/255,l.g/255,l.b/255),a.setX(o,l.life*.7);const i=e.charToUV[l.char];i&&r.setXY(o,i.u,i.v),n.setX(o,e.cellSize*(.7+l.life*.3)),o++}for(const l of q){if(o>=c)break;const i=Math.max(.05,l.life*l.life);A.position.set(l.x,-l.y,-l.z),A.updateMatrix(),e.particlesMesh.setMatrixAt(o,A.matrix),t.setXYZ(o,l.r/255,l.g/255,l.b/255),a.setX(o,i);const f=e.charToUV[l.char];f&&r.setXY(o,f.u,f.v),n.setX(o,e.cellSize*(.92+i*.5)),o++;const h=l.trailSegs.length;for(let d=0;d<h&&!(o>=c);d++){const m=l.trailSegs[d],x=h>1?d/(h-1):1,u=i*(.2+x*.6),M=e.cellSize*(.6+x*.35);A.position.set(m.x,-m.y,-m.z),A.updateMatrix(),e.particlesMesh.setMatrixAt(o,A.matrix),t.setXYZ(o,l.r/255,l.g/255,l.b/255),a.setX(o,u),f&&r.setXY(o,f.u,f.v),n.setX(o,M),o++}}e.particlesMesh.count=o,e.particlesMesh.instanceMatrix.needsUpdate=!0,t.needsUpdate=!0,a.needsUpdate=!0,r.needsUpdate=!0,n.needsUpdate=!0,Re()}const W=g.fuExplodeDelay,at=g.fuRiseDuration,Yt=g.fuShrinkDuration,$t=g.fuShrinkEndScale,Oe=g.fuCameraPullbackDuration,Ht=g.fuCameraReturnDuration,F=W+1.2,P=F+1.1,We=P+.4;let re=[],ee=[],ne=0;function Nt(){if(re=[],ee=[],ne=0,e.drawToFortuneSeed=null,!e.fontsReady)return;const s=Math.min(e.cols,e.rows)*.4*e.cellSize,t=s*.4,a=e.dajiShape.map(n=>({x:n.nx*s*.5*n.aspect,y:n.ny*s*.5,z:(Math.random()-.5)*t,brightness:n.brightness})),r=Ke(e.cols/2,e.rows*.22);for(let n=0;n<a.length;n++){const c=a[n],o=Math.random()*Math.PI*2,l=s*(.8+Math.random()*1.2),i=s*(.1+Math.random()*.4);re.push({x:r.x,y:r.y,z:0,startX:r.x,startY:r.y,startZ:0,scatterX:r.x+Math.cos(o)*l,scatterY:r.y+Math.sin(o)*l*.6+i,scatterZ:(Math.random()-.5)*t*1.6,targetX:c.x,targetY:c.y,targetZ:c.z,char:z[Math.floor(Math.random()*z.length)],scrambleTimer:0,finalChar:De(c.brightness),brightness:c.brightness,phase:Math.random()*Math.PI*2,fontIdx:Math.random()<.7?Math.floor(Math.random()*R.length):null,active:!1})}}function jt(s){const t=e.stateTime;if(t<W){const n=Math.min(1,t/Math.max(.001,at)),c=E(n),o=w(e.rows*.5,e.rows*.22,c),l=e.cols/2,i=Ke(l,o);Math.random()<.6&&ee.push({x:i.x+(Math.random()-.5)*e.cellSize*4,y:i.y+e.cellSize*(.9+Math.random()*2.2),z:(Math.random()-.5)*e.cellSize*3,vx:(Math.random()-.5)*e.cellSize*.08,vy:e.cellSize*(.08+Math.random()*.12),vz:(Math.random()-.5)*e.cellSize*.06,char:z[Math.floor(Math.random()*z.length)],life:1,decay:.015+Math.random()*.025})}if(t>=W&&t<W+.15){ne=1-(t-W)/.15;for(const n of re)n.active=!0}else t>=W+.15&&(ne=0);if(t>=W){for(const n of re)if(n.active)if(t<F){const c=(t-W)/(F-W),o=1-Math.pow(1-c,2);n.x=w(n.startX,n.scatterX,o),n.y=w(n.startY,n.scatterY,o)+o*e.cellSize*6,n.z=w(n.startZ,n.scatterZ,o);const l=c*e.cellSize*.8;n.x+=Math.sin(n.phase+e.globalTime*4)*l,n.y+=Math.cos(n.phase+e.globalTime*3)*l,n.z+=Math.sin(n.phase*.7+e.globalTime*3.2)*l*1.4,n.scrambleTimer-=1,n.scrambleTimer<=0&&(n.char=z[Math.floor(Math.random()*z.length)],n.scrambleTimer=2+Math.random()*3)}else if(t<P){const c=(t-F)/(P-F),o=E(c);n.x=w(n.scatterX,n.targetX,o),n.y=w(n.scatterY+e.cellSize*6,n.targetY,o),n.z=w(n.scatterZ,n.targetZ,o);const l=(1-o)*e.cellSize*.8;n.x+=Math.sin(n.phase+e.globalTime*4)*l,n.y+=Math.cos(n.phase+e.globalTime*3)*l,n.z+=Math.sin(n.phase*.7+e.globalTime*3.2)*l*1.4,n.scrambleTimer-=1,n.scrambleTimer<=0&&(n.char=c>.4?n.finalChar:z[Math.floor(Math.random()*z.length)],n.scrambleTimer=2+c*12)}else{const c=Math.min(1,(t-P)/Math.max(.001,We-P)),o=E(c);n.x=w(n.x,n.targetX,o),n.y=w(n.y,n.targetY,o),n.z=w(n.z,n.targetZ,o),n.char=n.finalChar}}const a=(e.rows*.5+2)*e.cellSize;let r=0;for(let n=0;n<ee.length;n++){const c=ee[n];c.x+=c.vx,c.y+=c.vy,c.z+=c.vz,c.vx*=.98,c.vz*=.98,c.life-=c.decay,c.life>0&&c.y<a&&(ee[r++]=c)}if(ee.length=r,t>=We+.3){const n=Ot();e.drawToFortuneSeed=n.length>0?n:null,s("fortune")}}function Ot(){const s=[];for(const t of re){if(!t.active)continue;const a=Math.min(1,t.brightness+.08),r=t.finalChar||De(a);if(r===" ")continue;const n=Pe(a);s.push({baseX:t.x,baseY:t.y,origZ:t.targetZ,char:r,fontIdx:t.fontIdx,r:n.r,g:n.g,b:n.b,alpha:.3+a*.7,lum:a,phase:t.phase})}return s}function Vt(s){const t=[];for(const n of ee)t.push({x:n.x,y:n.y,z:n.z,char:n.char,r:255,g:Math.floor(190+n.life*65),b:Math.floor(35+n.life*40),alpha:n.life*.68,size:.72+n.life*.35,glow:.9,blur:.8});const r=Math.min(e.cols,e.rows)*.4*e.cellSize*.06;for(const n of re){if(!n.active)continue;const c=n.brightness,o=255,l=180+c*75,i=c*50;let f=o,h=l,d=i,m,x=.95+c*.45;if(s<F){const T=1-(s-W)/(F-W),S=Math.sin(e.globalTime*25+n.phase*3)*.25*T;m=Math.min(1,Math.max(.1,.6+c*.3+S));const D=Math.sin(e.globalTime*18+n.phase*2)*.3*T;x*=1+D}else if(s<P){const T=(s-F)/(P-F),S=Math.sin(e.globalTime*8+n.phase)*.2*T;m=Math.min(1,Math.max(.2,.6+c*.3+S));const D=Math.sin(e.globalTime*6+n.phase)*.15*T;x*=1+D}else{const p=Math.min(1,(s-P)/(We-P)),T=Math.min(1,c+.08),S=Pe(T);f=w(o,S.r,p),h=w(l,S.g,p),d=w(i,S.b,p);const D=.3+T*.7,N=Math.min(1,(.5+c*.5)*(1+Math.sin(p*Math.PI)*.3));m=w(N,D,p),x=w(x,1.1,p)}let u=0;if(s>=P)u=1;else if(s>F){const p=(s-F)/(P-F);u=Math.max(0,p-.5)*2}const M=Math.sin(e.globalTime*1.5+n.phase)*r,y=n.z+M*u;t.push({x:n.x,y:n.y,z:y,char:n.char,fontIdx:n.fontIdx,r:Math.round(f),g:Math.round(h),b:Math.round(d),alpha:m,size:x,glow:.7,blur:.65})}Bt(t)}function Zt(){const s=e.stateTime;if(Vt(s),s<W){const t=Math.min(1,s/Math.max(.001,at)),a=Math.min(1,s/Math.max(.001,Yt)),r=E(t),n=E(a);e.ctx.save(),e.ctx.scale(e.dpr,e.dpr);const l=Math.min(window.innerWidth,window.innerHeight)*.55*w(1,$t,n),i=window.innerWidth/2,f=window.innerHeight*w(.5,.2,r);e.ctx.textAlign="center",e.ctx.textBaseline="middle",e.ctx.font=`${l}px ${e.chosenFont}, serif`;const h=1+t*2.5;e.ctx.globalAlpha=Math.min(1,.3*h),e.ctx.shadowColor=g.glowGold,e.ctx.shadowBlur=l*.2*h,e.ctx.fillStyle=g.glowGold,e.ctx.fillText("福",i,f),e.ctx.globalAlpha=1,e.ctx.shadowBlur=l*.08*h,e.ctx.fillText("福",i,f),e.ctx.shadowBlur=0,e.ctx.restore()}if(ne>0){e.ctx.save(),e.ctx.scale(e.dpr,e.dpr);const t=window.innerWidth/2,a=window.innerHeight*.22,r=Math.min(window.innerWidth,window.innerHeight)*.4*ne,n=e.ctx.createRadialGradient(t,a,0,t,a,r);n.addColorStop(0,`rgba(255, 255, 220, ${ne*.8})`),n.addColorStop(.4,`rgba(255, 215, 0, ${ne*.4})`),n.addColorStop(1,"rgba(255, 215, 0, 0)"),e.ctx.fillStyle=n,e.ctx.fillRect(0,0,window.innerWidth,window.innerHeight),e.ctx.restore()}}function qt(){Gt(),Rt()}function Jt(s,t,a,r,n){const o=a*1.5;for(let l=0;l<14;l++){const i=l*137.508,f=(r*2.5+l/14)%1,h=Math.sin(f*Math.PI)*n*.6;if(h<.02)continue;const d=i+e.globalTime*(1.2+l%3*.4),m=o*(.15+f*.85),x=s+Math.cos(d)*m,u=t+Math.sin(d)*m*.3,M=1+(1-f)*2.5;e.ctx.globalAlpha=h,e.ctx.fillStyle=g.glowGold,e.ctx.shadowColor=g.glowGold,e.ctx.shadowBlur=M*5,e.ctx.beginPath(),e.ctx.arc(x,u,M,0,Math.PI*2),e.ctx.fill()}}function Kt(s,t){const a=e.cellSize*5,r=1.3,n=window.innerWidth/2,c=window.innerHeight*.15,o=["大","吉"];if(s>=r){B("大 吉",.15,g.glowGold,.9,e.cellSize*5,t);return}e.ctx.save(),e.ctx.scale(e.dpr,e.dpr),e.ctx.font=`${a}px ${t}, serif`,e.ctx.textAlign="center",e.ctx.textBaseline="middle";const l=e.ctx.measureText("大 吉").width,i=e.ctx.measureText("大").width,f=e.ctx.measureText("吉").width,h=[n-l/2+i/2,n+l/2-f/2];for(let d=0;d<o.length;d++){const m=d*.2,x=r-m-.1,u=Math.max(0,Math.min(1,(s-m)/x));if(u<=0)continue;let M;u<.35?M=w(1.8,.93,E(u/.35)):u<.6?M=w(.93,1.06,E((u-.35)/.25)):M=w(1.06,1,E((u-.6)/.4));const y=Math.min(.9,u*3),p=1+Math.max(0,1-u*1.5)*2.5,T=Math.max(0,1-u*2.5)*a*.1;e.ctx.save(),e.ctx.translate(h[d],c+T),e.ctx.scale(M,M),e.ctx.globalAlpha=y*.35*p,e.ctx.fillStyle=g.glowGold,e.ctx.shadowColor=g.glowGold,e.ctx.shadowBlur=a*.25*p,e.ctx.fillText(o[d],0,0),e.ctx.globalAlpha=y,e.ctx.shadowBlur=a*.12,e.ctx.fillText(o[d],0,0),e.ctx.restore()}e.ctx.shadowBlur=0,e.ctx.shadowColor="transparent",e.ctx.restore()}function Qt(s,t,a,r){e.ctx.save(),e.ctx.scale(e.dpr,e.dpr);const n=e.cellSize*5,c=window.innerWidth/2,o=window.innerHeight*.15,l=t*.9,i=["大","吉"];e.ctx.font=`${n}px ${a}, serif`,e.ctx.textAlign="center",e.ctx.textBaseline="middle";const f=e.ctx.measureText("大 吉").width,h=e.ctx.measureText("大").width,d=e.ctx.measureText("吉").width,m=[c-f/2+h/2,c+f/2-d/2];e.ctx.font=`${n}px ${r}, serif`;const x=e.ctx.measureText("大 吉").width,u=e.ctx.measureText("大").width,M=e.ctx.measureText("吉").width,y=[c-x/2+u/2,c+x/2-M/2],p=.3,T=.1,S=.7,D=.45,N=s<.15?s/.15:s>.85?(1-s)/.15:1;if(Jt(c,o,n,s,l*N),s<p){const _=s/p;e.ctx.font=`${n}px ${a}, serif`,e.ctx.textAlign="center",e.ctx.textBaseline="middle";for(let b=0;b<i.length;b++){const X=b*.2,v=Math.max(0,Math.min(1,(_-X)/(1-X))),L=Math.sin(e.globalTime*35+b*2.7)*v*n*.05,C=Math.cos(e.globalTime*28+b*1.9)*v*n*.035,J=-v*v*n*.1,Y=l*(1-v*v),j=v*n*.025,K=m[b]+L,$=o+C+J;j>.5&&(e.ctx.globalAlpha=Y*.3,e.ctx.fillStyle="#FF4444",e.ctx.shadowColor="#FF4444",e.ctx.shadowBlur=n*.12,e.ctx.fillText(i[b],K-j,$),e.ctx.fillStyle="#FFEE44",e.ctx.shadowColor="#FFEE44",e.ctx.fillText(i[b],K+j,$+j*.3)),e.ctx.globalAlpha=Y,e.ctx.fillStyle=g.glowGold,e.ctx.shadowColor=g.glowGold,e.ctx.shadowBlur=n*(.15+v*.25),e.ctx.fillText(i[b],K,$)}}if(s>=T&&s<S){const _=(s-T)/(S-T),b=w(18,3,_*_),X=Math.floor(e.globalTime*b),v=E(_),L=_<.15?_/.15:_>.7?(1-_)/.3:1;e.ctx.font=`${n}px ${_<.5?a:r}, serif`,e.ctx.textAlign="center",e.ctx.textBaseline="middle";for(let C=0;C<i.length;C++){const J=z[(X+C*13)%z.length],Y=Math.sin(e.globalTime*5+C*2)*n*.035,j=Math.cos(e.globalTime*3.5+C*2.5)*n*.02,K=w(m[C],y[C],v)+j,$=o+Y,ce=1+Math.sin(e.globalTime*8+C)*.05;e.ctx.save(),e.ctx.translate(K,$),e.ctx.scale(ce,ce),e.ctx.globalAlpha=l*L*.7,e.ctx.fillStyle=g.glowGold,e.ctx.shadowColor=g.glowGold,e.ctx.shadowBlur=n*.2,e.ctx.fillText(J,0,0),e.ctx.restore()}}if(s>=D){const _=(s-D)/(1-D);e.ctx.font=`${n}px ${r}, serif`,e.ctx.textAlign="center",e.ctx.textBaseline="middle";for(let b=0;b<i.length;b++){const X=b*.15,v=Math.max(0,Math.min(1,(_-X)/(1-X))),L=E(v);let C;v<.45?C=L/.45*1.1:v<.7?C=w(1.1,.97,E((v-.45)/.25)):C=w(.97,1,E((v-.7)/.3));const J=(1-L)*n*.12,Y=1+Math.sin(v*Math.PI)*.5;e.ctx.save(),e.ctx.translate(y[b],o+J),e.ctx.scale(C,C),e.ctx.globalAlpha=l*L*.35*Y,e.ctx.fillStyle=g.glowGold,e.ctx.shadowColor=g.glowGold,e.ctx.shadowBlur=n*.3*Y,e.ctx.fillText(i[b],0,0),e.ctx.globalAlpha=l*L,e.ctx.shadowBlur=n*.12,e.ctx.fillText(i[b],0,0),e.ctx.restore()}}e.ctx.shadowBlur=0,e.ctx.shadowColor="transparent",e.ctx.restore()}function en(){const s=Lt();Z.length||O.length||q.length?Xt(s):Re();const t=Math.min(1,e.stateTime/.9),a=Dt();if(a){const o=(e.globalTime-a.startTime)/1.2;o>=1?(Pt(),B("大 吉",.15,g.glowGold,t*.9,e.cellSize*5,ge())):Qt(o,t,a.oldFont,ge())}else e.stateTime<1.5?Kt(e.stateTime,ge()):B("大 吉",.15,g.glowGold,t*.9,e.cellSize*5,ge());const r=Math.min(1,Math.max(0,(e.stateTime-.5)/.9));if(B("万事如意 · 心想事成",.82,g.glowRed,r*.7,e.cellSize*1.5),B("May all your wishes come true",.87,g.glowGold,r*.5,e.cellSize*1),!document.querySelector(".envelope-panel.active")&&e.stateTime>2.5&&e.envelopeManager){const c=Math.min(1,(e.stateTime-2.5)/.5),o=.4+Math.sin(e.globalTime*3)*.2;e.envelopeManager.state.wished?(B("↑  查看详情  ↑",.94,g.glowGold,c*o,e.cellSize*1),B("Swipe Up to View Status",.97,g.glowGold,c*o,e.cellSize*.8)):(B("↑  上滑许愿  ↑",.94,g.glowGold,c*o,e.cellSize*1.2),B("Swipe Up to Make a Wish",.97,g.glowGold,c*o,e.cellSize*.9))}}let Se=0,Ce=0,Ve=0,Ae=!1,H=null,Ee=0,_e=0,Ze=0,pe=!1,le=null;function tn(s){e.canvas.addEventListener("touchstart",t=>{const a=t.touches[0];Se=a.clientX,Ce=a.clientY,Ee=a.clientX,_e=a.clientY,Ve=performance.now(),Ae=!1,H&&clearTimeout(H),e.state==="fortune"&&(H=setTimeout(()=>{Ae||me(Ee,_e)},250))},{passive:!0}),e.canvas.addEventListener("touchmove",t=>{const a=t.touches[0];Ee=a.clientX,_e=a.clientY,(Math.abs(a.clientX-Se)>10||Math.abs(a.clientY-Ce)>10)&&(Ae=!0,H&&(clearTimeout(H),H=null)),e.state==="fortune"&&me(a.clientX,a.clientY)},{passive:!0}),e.canvas.addEventListener("touchend",t=>{H&&(clearTimeout(H),H=null),Te();const a=t.changedTouches[0].clientX-Se,r=Ce-t.changedTouches[0].clientY,n=performance.now()-Ve;e.state==="fortune"&&Math.abs(a)>50&&Math.abs(a)>Math.abs(r)&&n<500?we():r>50&&n<500&&s()},{passive:!0}),e.canvas.addEventListener("mousemove",t=>{e.state==="fortune"&&pe&&me(t.clientX,t.clientY)}),e.canvas.addEventListener("mouseleave",()=>{Te()}),e.canvas.addEventListener("mousedown",t=>{Ze=t.clientY,pe=!0,le&&clearTimeout(le),e.state==="fortune"&&(le=setTimeout(()=>{me(t.clientX,t.clientY)},250))}),e.canvas.addEventListener("mouseup",t=>{le&&(clearTimeout(le),le=null),Te(),pe&&Ze-t.clientY>50&&s(),pe=!1}),e.canvas.addEventListener("wheel",t=>{t.deltaY<-30&&s()},{passive:!0}),window.addEventListener("keydown",t=>{const a=document.activeElement,r=a?a.tagName:"";r==="INPUT"||r==="TEXTAREA"||a&&a.isContentEditable||((t.code==="Space"||t.code==="ArrowUp")&&(t.preventDefault(),s()),e.state==="fortune"&&(t.code==="ArrowLeft"&&(t.preventDefault(),we()),t.code==="ArrowRight"&&(t.preventDefault(),we())))})}const st="https://eakkajhgtmjrpylntbgl.supabase.co",it="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVha2thamhndG1qcnB5bG50YmdsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzEwMjk1MzgsImV4cCI6MjA4NjYwNTUzOH0.dcCJqpNavukOe53dlunmT4COfVwFNGhAgBUCqaJ5eSk",nn=`${st}/functions/v1`,qe=yt(st,it),ke=new URLSearchParams(window.location.search),U=ke.get("p"),Me=ke.get("uid"),ot=ke.get("ctr"),ze=!!(U&&Me);if(Me||ot){const s=U?`${window.location.pathname}?p=${U}`:window.location.pathname;window.history.replaceState(null,"",s)}async function de(s,t){return(await fetch(`${nn}/${s}`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${it}`},body:JSON.stringify(t)})).json()}const Q={async validateTap(s,t,a){return de("validate-tap",{pieceId:s,uid:t,ctr:a})},async getWishHistory(s){const{data:t,error:a}=await qe.from("wishes").select("id, wish_text, sealed, display_type, created_at").eq("piece_id",s).order("created_at",{ascending:!1});return a?(console.error("[API] getWishHistory error:",a),[]):t},async getAllWishHistory(){const{data:s,error:t}=await qe.from("wishes").select("id, piece_id, wish_text, sealed, display_type, created_at").order("created_at",{ascending:!1});return t?(console.error("[API] getAllWishHistory error:",t),[]):s},async sealWish(s,t,a){return de("seal-wish",{pieceId:s,wishText:t,sessionToken:a})},async unseal(s,t,a){return de("unseal",{pieceId:s,wishText:t,sessionToken:a})},async verifyChallenge(s,t,a){return de("verify-challenge",{pieceId:s,wishText:t,sessionToken:a})},async claimGoldenFinger(s,t){return de("claim-golden-finger",{pieceId:s,sessionToken:t})}};class an{constructor({onOpen:t,onWish:a}){this.onOpen=t,this.onWish=a,this.state={pieceId:U,isNfcTap:ze,validated:!1,pieceType:"regular",sealed:!1,btcAddress:null,sessionToken:null,wished:!1,currentWishText:null,challengePassed:!1},this._devMode=!1,this._mockWishes=[],this.panel=document.getElementById("envelope-panel"),this._bindEvents(),this._init()}enableDevMode(){this._devMode=!0,this._mockWishes=[{id:"d1",piece_id:"03",wish_text:"World peace and kindness for all",sealed:!1,display_type:"regular",created_at:"2026-01-28T10:00:00Z"},{id:"d2",piece_id:"01",wish_text:null,sealed:!0,display_type:"gold",created_at:"2026-02-10T12:00:00Z"},{id:"d3",piece_id:"07",wish_text:"Success in all my studies this year",sealed:!1,display_type:"regular",created_at:"2026-01-20T08:00:00Z"},{id:"d4",piece_id:"12",wish_text:null,sealed:!0,display_type:"regular",created_at:"2026-02-05T15:00:00Z"},{id:"d5",piece_id:"05",wish_text:"Health and happiness for my family",sealed:!1,display_type:"regular",created_at:"2026-01-15T09:00:00Z"}],console.log("[Envelope] Dev mode enabled — API calls mocked")}async _init(){const t=a=>{let r=document.getElementById("_dbg");r||(r=document.createElement("div"),r.id="_dbg",r.style.cssText="position:fixed;top:0;left:0;right:0;z-index:99999;background:rgba(0,0,0,0.85);color:#0f0;font:11px monospace;padding:6px;max-height:30vh;overflow:auto;",document.body.appendChild(r)),r.textContent+=a+`
`};if(t(`NFC_TAP=${ze} p=${U} uid=${Me}`),ze)try{t("calling validate-tap...");const a=await Q.validateTap(U,Me,ot);t(`result: ${JSON.stringify(a)}`),a.valid&&(this.state.validated=!0,this.state.pieceType=a.piece_type,this.state.sealed=a.sealed,this.state.btcAddress=a.btc_address,this.state.sessionToken=a.session_token)}catch(a){t(`ERROR: ${a.message}`),console.error("[Envelope] Validation failed:",a)}t(`validated=${this.state.validated} type=${this.state.pieceType}`),await this._loadWishHistory(),this._renderPieceBadge(),this._updateSections()}_bindEvents(){const t=document.getElementById("btn-submit-wish");t&&t.addEventListener("click",()=>this._handleSealWish());const a=document.getElementById("envelope-overlay");a&&a.addEventListener("click",h=>{h.target===a&&this.hide()});const r=document.getElementById("btn-unseal");r&&r.addEventListener("click",()=>{const h=document.getElementById("unseal-area");if(h){const d=h.style.display!=="none";h.style.display=d?"none":"",r.style.display=d?"":"none"}});const n=document.getElementById("btn-confirm-unseal");n&&n.addEventListener("click",()=>this._handleUnseal());const c=document.getElementById("btn-golden-finger");c&&c.addEventListener("click",()=>this._handleGoldenFinger());const o=document.getElementById("btc-button");o&&o.addEventListener("click",h=>{if(!o.classList.contains("revealed")){o.classList.add("revealed");return}const d=document.getElementById("btc-address");d&&d.textContent&&navigator.clipboard.writeText(d.textContent).then(()=>{const m=d.textContent;d.textContent="Copied!",setTimeout(()=>{d.textContent=m},1500)})});const l=document.getElementById("unseal-input");l&&l.addEventListener("keydown",h=>{h.key==="Enter"&&this._handleUnseal()});const i=document.getElementById("btn-challenge-submit");i&&i.addEventListener("click",()=>this._handleChallenge());const f=document.getElementById("challenge-input");f&&f.addEventListener("keydown",h=>{h.key==="Enter"&&this._handleChallenge()})}show(){const t=document.getElementById("envelope-overlay");this.panel&&(this.panel.classList.remove("dismissing"),this.panel.classList.add("active"),t&&(t.style.pointerEvents="auto")),this._updateSections()}hide(){const t=document.getElementById("envelope-overlay");t&&(t.style.pointerEvents="none"),this.panel&&this.panel.classList.contains("active")&&(this.panel.classList.remove("active"),this.panel.classList.add("dismissing"),this.panel.addEventListener("animationend",()=>{this.panel.classList.remove("dismissing")},{once:!0}))}showPanel(){this.show()}hideAll(){this.hide()}_updateSections(){const t=document.getElementById("section-wish"),a=document.getElementById("section-sealed"),r=document.getElementById("section-challenge");t&&(t.style.display="none"),a&&(a.style.display="none"),r&&(r.style.display="none"),this.state.validated&&(this.state.sealed&&!this.state.wished&&!this.state.challengePassed?r&&(r.style.display=""):this.state.wished||this.state.challengePassed?(a&&(a.style.display=""),this.state.challengePassed&&!this.state.sealed&&t&&(t.style.display="")):t&&(t.style.display=""));const n=document.getElementById("challenge-error");n&&(n.textContent="");const c=document.getElementById("unseal-area"),o=document.getElementById("btn-unseal");c&&(c.style.display="none"),o&&(o.style.display=this.state.sealed?"":"none");const l=document.getElementById("btc-address");l&&(l.textContent=this.state.btcAddress||"");const i=document.getElementById("btc-button");i&&i.classList.remove("revealed");const f=document.getElementById("btn-golden-finger");f&&(f.style.display=this.state.pieceType==="gold"?"":"none");const h=document.getElementById("seal-error");h&&(h.textContent="")}async _loadWishHistory(){if(this._devMode){this._renderWishTimeline(this._mockWishes);return}let t;U?t=await Q.getWishHistory(U):t=await Q.getAllWishHistory(),this._renderWishTimeline(t)}_renderWishTimeline(t){const a=document.getElementById("wish-timeline-list");if(!a)return;if(a.innerHTML="",!t||t.length===0){a.innerHTML='<div style="font-size:0.8rem;color:#666;padding:0.5rem 0;">No wishes yet. Be the first.</div>';return}const r=[...t].sort((n,c)=>new Date(c.created_at)-new Date(n.created_at));for(const n of r){const c=document.createElement("div");c.className="wish-entry";const o=document.createElement("div");o.className="wish-text";const l=document.createElement("div");l.className="wish-date";const i=n.piece_id?`Piece #${n.piece_id}  ·  `:"";l.textContent=i+this._formatDate(n.created_at);const f=n.display_type==="gold";f&&c.classList.add("gold"),n.sealed?(c.classList.add("sealed"),f||c.classList.add("regular"),o.textContent=f?"A golden wish has been sealed":"A wish has been sealed"):o.textContent=`"${n.wish_text||""}"`,c.appendChild(o),c.appendChild(l),a.appendChild(c)}}_formatDate(t){return new Date(t).toLocaleDateString("en-US",{month:"short",day:"numeric",year:"numeric"})}_renderPieceBadge(){const t=document.getElementById("piece-badge-slot");if(t&&U){const a=this.state.pieceType,r=document.createElement("span");r.className=`piece-badge ${a}`,r.textContent=`Piece #${U} · ${a==="gold"?"GOLD":"REGULAR"}`,t.replaceChildren(r)}}async _handleSealWish(){const t=document.getElementById("wish-input"),a=t?t.value.trim():"";if(!a)return;const r=document.getElementById("btn-submit-wish");r&&(r.disabled=!0);try{if(this._devMode){this._mockWishes.unshift({id:"dev-"+Date.now(),wish_text:null,sealed:!0,display_type:this.state.pieceType==="gold"?"gold":"regular",created_at:new Date().toISOString()}),this.state.sealed=!0,this.state.wished=!0,this.state.challengePassed=!1,this.state.currentWishText=a,t&&(t.value=""),this.onWish&&this.onWish(),this._updateSections(),this._renderWishTimeline(this._mockWishes);return}const n=await Q.sealWish(this.state.pieceId,a,this.state.sessionToken);if(n.success)this.state.sealed=!0,this.state.wished=!0,this.state.challengePassed=!1,this.state.currentWishText=a,t&&(t.value=""),this.onWish&&this.onWish(),this._updateSections(),await this._loadWishHistory();else{const c=document.getElementById("seal-error");c&&(c.textContent=n.error==="Already sealed"?"Someone just sealed this piece! Tap the NFC again to try the challenge.":n.error||"Something went wrong. Try again.")}}catch(n){console.error("[Envelope] Seal failed:",n);const c=document.getElementById("seal-error");c&&(c.textContent="Something went wrong. Try again.")}finally{r&&(r.disabled=!1)}}async _handleUnseal(){const t=document.getElementById("unseal-input"),a=document.getElementById("unseal-error"),r=t?t.value.trim():"";if(!r){a&&(a.textContent="Please enter your wish.");return}const n=document.getElementById("btn-confirm-unseal");n&&(n.disabled=!0),a&&(a.textContent="");try{if(this._devMode){const o=this._mockWishes.find(l=>l.sealed);o&&(o.sealed=!1,o.wish_text=r),this.state.sealed=!1,this.state.wished=!1,this.state.challengePassed=!1,this.state.currentWishText=null,t&&(t.value=""),this._renderWishTimeline(this._mockWishes),this._updateSections();return}(await Q.unseal(this.state.pieceId,r,this.state.sessionToken)).success?(this.state.sealed=!1,this.state.wished=!1,this.state.challengePassed=!1,this.state.currentWishText=null,t&&(t.value=""),await this._loadWishHistory(),this._updateSections()):a&&(a.textContent="Wish does not match. Try again.")}catch(c){console.error("[Envelope] Unseal failed:",c),a&&(a.textContent="Something went wrong. Try again.")}finally{n&&(n.disabled=!1)}}async _handleChallenge(){const t=document.getElementById("challenge-input"),a=document.getElementById("challenge-error"),r=((t==null?void 0:t.value)||"").trim();if(!r){a&&(a.textContent="Please enter the wish.");return}const n=document.getElementById("btn-challenge-submit");n&&(n.disabled=!0),a&&(a.textContent="");try{if(this._devMode){this.state.challengePassed=!0,t&&(t.value=""),this._updateSections();return}(await Q.verifyChallenge(this.state.pieceId,r,this.state.sessionToken)).success?(this.state.challengePassed=!0,t&&(t.value=""),this._updateSections()):a&&(a.textContent="Wish does not match. Try again.")}catch(c){console.error("[Envelope] Challenge failed:",c),a&&(a.textContent="Something went wrong. Try again.")}finally{n&&(n.disabled=!1)}}async _handleGoldenFinger(){const t=document.getElementById("btn-golden-finger");t&&(t.disabled=!0);try{const a=await Q.claimGoldenFinger(this.state.pieceId,this.state.sessionToken);a.token&&a.redirect_url&&(window.location.href=`${a.redirect_url}?golden_token=${a.token}`)}catch(a){console.error("[Envelope] Golden finger claim failed:",a)}finally{t&&(t.disabled=!1)}}}e.canvas=document.getElementById("c");e.ctx=e.canvas.getContext("2d");window.addEventListener("resize",Qe);Qe();Et();function be(s){e.state=s,e.stateStartGlobal=e.globalTime,e.stateTime=0,s==="draw"&&Nt(),s==="fortune"&&(e.drawToFortuneSeed&&e.drawToFortuneSeed.length>0?(Ne(e.drawToFortuneSeed),e.drawToFortuneSeed=null):Ne(),nt())}function sn(){e.state==="arrival"&&e.fontsReady?be("draw"):e.state==="fortune"&&e.envelopeManager&&e.envelopeManager.show()}tn(sn);Promise.all(R.map(s=>document.fonts.load(`64px ${s}`,"福大吉"))).then(()=>{e.fuShape=He("福",64,e.chosenFont),e.dajiShape=He("大吉",64),e.fontsReady=!0,It(),e.envelopeManager=new an({onOpen:()=>{e.state==="arrival"&&be("draw")},onWish:()=>{nt()}}),new URLSearchParams(window.location.search).has("dev")&&vt(()=>import("./dev-B6DQPL-N.js"),__vite__mapDeps([0,1,2])).then(s=>s.initDevTool({changeState:be}))});function on(){Ie(e.globalTime)}function ln(){const s=Math.min(1,e.stateTime/1);Wt(s);const t=Math.min(1,e.stateTime/1.5);B("新年纳福",.15,g.glowGold,t*.8,e.cellSize*2),B("A Blessing Awaits",.2,g.glowGold,t*.5,e.cellSize*1.1);const a=Math.min(1,Math.max(0,(e.stateTime-1.5)/.5)),r=.4+Math.sin(e.globalTime*3)*.2,n=e.globalTime%3;let c=0;if(n<.9){const o=1-n/.9;c=-Math.abs(Math.sin(n/.9*Math.PI*3))*.012*o}B("↑  上滑抽签  ↑",.88+c,g.glowGold,a*r,e.cellSize*1.6),B("Swipe Up to Draw Fortune",.92+c,g.glowGold,a*r,e.cellSize*1.1)}const rn=performance.now(),Je=g.fuExplodeDelay;function lt(s){switch(e.globalTime=(s-rn)/1e3,e.stateTime=e.globalTime-e.stateStartGlobal,Tt(),e.state){case"arrival":on();break;case"draw":Ie(e.globalTime),jt(be);break;case"fortune":Ie(e.globalTime),qt();break}let t=0;if(e.state==="draw"){if(e.stateTime<Je)if(e.stateTime<Oe){const a=Math.min(1,e.stateTime/Math.max(.001,Oe));t=-E(a)*e.cellSize*3}else t=-e.cellSize*3;else{const a=Math.min(1,(e.stateTime-Je)/Math.max(.001,Ht));t=-(1-E(a))*e.cellSize*3}e.offsetY+=t}switch(At(),t!==0&&(e.offsetY-=t),e.particlesMesh&&(e.particlesMesh.count=0),e.state){case"arrival":ln();break;case"draw":Zt();break;case"fortune":en();break}requestAnimationFrame(lt)}requestAnimationFrame(lt);export{e as S};
