import"./modulepreload-polyfill-B5Qt9EMX.js";import{O as me,aj as we,E as Me,ai as xe,az as be,m as Ot,ay as ye,al as ve,V as Se,aA as Ae,aB as Nt,aC as Te,I as Ce,i as bt}from"./three.module-aEEDt9MZ.js";const ze=`// Particle vertex shader — billboarded instanced quads
// Uses instanceMatrix from Three.js InstancedMesh (set via setMatrixAt)

attribute vec3 instanceColor;     // RGB normalized 0-1
attribute float instanceAlpha;
attribute vec2 instanceUV;        // atlas cell UV offset
attribute float instanceScale;    // quad size in world units

uniform vec2 cellSize;            // UV size of one atlas cell (1/cols, 1/rows)

varying vec2 vUv;
varying vec3 vColor;
varying float vAlpha;

void main() {
    // Extract world position from instanceMatrix (translation column)
    vec4 worldPos = instanceMatrix * vec4(0.0, 0.0, 0.0, 1.0);

    // Transform to view space
    vec4 mvPosition = modelViewMatrix * worldPos;

    // Billboard: expand unit quad in view space (always faces camera)
    mvPosition.xy += position.xy * instanceScale;

    gl_Position = projectionMatrix * mvPosition;

    // Map quad UV (0..1) into this character's atlas cell
    vUv = instanceUV + uv * cellSize;
    vColor = instanceColor;
    vAlpha = instanceAlpha;
}
`,Fe=`// Particle fragment shader — samples character atlas, applies color tint
// Atlas: white chars with baked glow on BLACK background (R channel = intensity)
// Output: premultiplied alpha for additive blending

uniform sampler2D atlas;

varying vec2 vUv;
varying vec3 vColor;
varying float vAlpha;

void main() {
    float raw = texture2D(atlas, vUv).r;
    float intensity = pow(raw, 0.75); // Lift dim glow fringe for softer halo
    float alpha = intensity * vAlpha;
    if (alpha < 0.01) discard;

    // Premultiplied color for additive blending (src + dst)
    gl_FragColor = vec4(vColor * alpha, alpha);
}
`,Y=document.getElementById("c"),o=Y.getContext("2d"),p={bg:"#990000",glowRed:"#FF2D2D",glowGold:"#FFD700",glowGreen:"#00FF9F",scatterDur:450,scrambleDur:900,convergeDur:450,settleDur:250,fuExplodeDelay:2,fuRiseDuration:.8,fuShrinkDuration:.8,fuShrinkEndScale:.18,fuCameraPullbackDuration:.45,fuCameraReturnDuration:.7,shellRiseDuration:2.5},St=[" ","·","一","人","十","大","吉","平","安","和","春","利","兴","旺","发","金","贵","富","财","寿","禄","喜","龙","凤","福"],W="福禄寿喜财富贵发金玉宝余丰盛利旺隆昌兴进安康宁泰和平顺健乐欢庆禧祺嘉春德善仁义忠信孝慧恩爱合圆满美馨雅吉祥瑞如意祝运龙凤麟鹤华成升登高",Ut={一:{phrase:"一帆风顺",english:"Smooth sailing in all endeavors"},人:{phrase:"人寿年丰",english:"Long life and abundant harvests"},十:{phrase:"十全十美",english:"Perfection in every way"},大:{phrase:"大吉大利",english:"Great luck and great profit"},吉:{phrase:"吉祥如意",english:"Good fortune as you wish"},平:{phrase:"四季平安",english:"Peace through all four seasons"},安:{phrase:"岁岁平安",english:"Peace and safety year after year"},和:{phrase:"和气生财",english:"Harmony brings prosperity"},春:{phrase:"春风得意",english:"Success on the spring breeze"},利:{phrase:"开岁大利",english:"Great profit in the new year"},兴:{phrase:"兴旺发达",english:"Flourishing and thriving"},旺:{phrase:"人丁兴旺",english:"A growing and prosperous family"},发:{phrase:"恭喜发财",english:"Wishing you great prosperity"},金:{phrase:"金玉满堂",english:"Gold and jade fill the hall"},贵:{phrase:"荣华富贵",english:"Glory, splendor, and riches"},富:{phrase:"富贵有余",english:"Wealth and abundance to spare"},财:{phrase:"财源广进",english:"Wealth flowing from all directions"},寿:{phrase:"福寿双全",english:"Both blessings and longevity"},禄:{phrase:"高官厚禄",english:"High rank and generous reward"},喜:{phrase:"双喜临门",english:"Double happiness at the door"},龙:{phrase:"龙马精神",english:"The vigor of dragons and horses"},凤:{phrase:"龙凤呈祥",english:"Dragon and phoenix bring fortune"},福:{phrase:"福星高照",english:"The star of fortune shines bright"}},ct=['"Zhi Mang Xing"','"Liu Jian Mao Cao"','"Ma Shan Zheng"','"TsangerZhoukeZhengdabangshu"','"hongleixingshu"','"qiantubifengshouxieti"','"峄山碑篆体"'],Et=ct[Math.floor(Math.random()*ct.length)];let At=0,pt=null,kt=0;const De=4.5;function yt(){return ct[At]}function Ct(e){const t=ct[At];At=(At+e+ct.length)%ct.length,pt={oldFont:t,startTime:d},kt=d}function M(e,t,i){return e+(t-e)*i}function X(e){return e<.5?2*e*e:-1+(4-2*e)*e}const ft=500;function Vt(e,t,i,n){const a=n/(n+i);return{screenX:e*a+window.innerWidth/2,screenY:t*a+window.innerHeight/2,scale:a}}function zt(e,t){return{x:(e-A/2)*h,y:(t-T/2)*h}}let h,A,T,qt,Kt,ae,Ft,F=Math.min(window.devicePixelRatio||1,2),tt,Dt,ot,g,wt={};function oe(){F=Math.min(window.devicePixelRatio||1,2),Y.width=window.innerWidth*F,Y.height=window.innerHeight*F,Y.style.width=window.innerWidth+"px",Y.style.height=window.innerHeight+"px";const e=Math.min(window.innerWidth,window.innerHeight);if(h=Math.max(10,Math.floor(e*.028)),A=Math.floor(window.innerWidth/h),T=Math.floor(window.innerHeight/h),qt=A*h,Kt=T*h,ae=(window.innerWidth-qt)/2,Ft=(window.innerHeight-Kt)/2,tt){tt.setSize(window.innerWidth,window.innerHeight),tt.setPixelRatio(F);const t=2*Math.atan(window.innerHeight/(2*ft))*(180/Math.PI);ot.fov=t,ot.aspect=window.innerWidth/window.innerHeight,ot.updateProjectionMatrix()}}window.addEventListener("resize",oe);oe();const gt=16,vt=16,at=64;function Re(){tt=new we({alpha:!0,antialias:!1}),tt.setSize(window.innerWidth,window.innerHeight),tt.setPixelRatio(F);const e=2*Math.atan(window.innerHeight/(2*ft))*(180/Math.PI);ot=new Me(e,window.innerWidth/window.innerHeight,1,3e3),ot.position.set(0,0,ft),ot.lookAt(0,0,0),Dt=new xe;const t=document.createElement("canvas");t.width=gt*at,t.height=vt*at;const i=t.getContext("2d");i.fillStyle="#000",i.fillRect(0,0,t.width,t.height);const n=new Set([...St,...W.split(""),...Object.keys(Ut),"·"]);i.font=`bold ${Math.floor(at*.7)}px "Courier New", "SF Mono", monospace`,i.textAlign="center",i.textBaseline="middle",i.fillStyle="#FFFFFF",i.shadowColor="white",i.shadowBlur=at*.12;let a=0;n.forEach(b=>{if(a>=gt*vt)return;const w=a%gt,S=Math.floor(a/gt),v=w*at+at/2,y=S*at+at/2;i.fillText(b,v,y),wt[b]={u:w/gt,v:1-(S+1)/vt},a++});const c=new be(t);c.magFilter=Ot,c.minFilter=Ot;const l=4e3,r=new ye(1,1),s=new ve({uniforms:{atlas:{value:c},cellSize:{value:new Se(1/gt,1/vt)}},vertexShader:ze,fragmentShader:Fe,transparent:!0,blending:Ae,blendSrc:Nt,blendDst:Nt,blendEquation:Te,depthWrite:!1,depthTest:!1});g=new Ce(r,s,l);const f=new Float32Array(l*3),u=new Float32Array(l),m=new Float32Array(l*2),x=new Float32Array(l);g.geometry.setAttribute("instanceColor",new bt(f,3)),g.geometry.setAttribute("instanceAlpha",new bt(u,1)),g.geometry.setAttribute("instanceUV",new bt(m,2)),g.geometry.setAttribute("instanceScale",new bt(x,1)),g.frustumCulled=!1,Dt.add(g)}let Rt=[];function Ee(){Rt=new Array(T*A).fill(null)}function se(e,t,i,n,a,c,l,r){if(e<0||e>=A||t<0||t>=T)return;const s=t*A+e,f=Rt[s];f&&f.depth<=i||(Rt[s]={char:n,r:a,g:c,b:l,alpha:r,depth:i})}function Jt(e,t,i){const n=document.createElement("canvas"),a=n.getContext("2d"),c=[...e].length,l=t*c,r=t;n.width=l,n.height=r,a.fillStyle="#000",a.fillRect(0,0,l,r),a.fillStyle="#fff",a.textAlign="center",a.textBaseline="middle";const s=i||'"SimSun", "STSong", "Songti SC", "Noto Serif SC", serif';a.font=`bold ${Math.floor(t*.85)}px ${s}`,a.fillText(e,l/2,r/2);const u=a.getImageData(0,0,l,r).data,m=[],x=c>1?2:1;for(let b=0;b<r;b+=x)for(let w=0;w<l;w+=x){const S=(b*l+w)*4,v=u[S]/255;v>.1&&m.push({nx:w/l*2-1,ny:b/r*2-1,brightness:v,aspect:c})}return m}function Bt(e){const t=Math.floor(e*(St.length-1));return St[Math.max(0,Math.min(t,St.length-1))]}function Pt(e){const i=Math.floor(45+e*170),n=Math.floor(45-e*45);return{r:255,g:i,b:n}}let Xt=[],Gt=!1;Promise.all(ct.map(e=>document.fonts.load(`64px ${e}`,"福大吉"))).then(()=>{Jt("福",64,Et),Xt=Jt("大吉",64),Gt=!0,Re()});let $=[],ht=0,q=!1,K=-1;function Qt(e){if($=[],K=-1,q=!1,ut(),Array.isArray(e)&&e.length>0){$=e.map(n=>({...n})),q=!0,ht=d;return}if(!Gt)return;const t=Math.min(A,T)*.4*h,i=t*.4;for(const n of Xt){const a=Math.min(1,n.brightness+.08),c=Bt(a);if(c===" ")continue;const l=Pt(a);$.push({baseX:n.nx*t*.5*n.aspect,baseY:n.ny*t*.5,origZ:(Math.random()-.5)*i,char:c,r:l.r,g:l.g,b:l.b,alpha:.3+a*.7,lum:a,phase:Math.random()*Math.PI*2})}ht=d}function Be(e){if(!g)return 0;if(!$.length)return g.count=0,0;const t=Math.min(A,T)*.4*h,i=Math.min(1,(d-ht)/1.2),n=q?1:X(i),a=q?Math.min(1,(d-ht)/.6):1,c=q?0:.5,l=q?1:Math.min(1,Math.max(0,(d-ht-c)/.8)),r=t*.06*l,s=g.geometry.attributes.instanceColor,f=g.geometry.attributes.instanceAlpha,u=g.geometry.attributes.instanceUV,m=g.geometry.attributes.instanceScale,x=s.count,b=Math.min($.length,x),w=t*.5,S=Math.sin(d*.8)*.3;for(let v=0;v<b;v++){const y=$[v],P=y.origZ*n+Math.sin(d*1.5+y.phase)*r,B=v===K,U=B?-80:0;E.position.set(y.baseX,-y.baseY,-(P+U)),E.updateMatrix(),g.setMatrixAt(v,E.matrix);let et=y.alpha*Math.max(.2,1.25);et=Math.min(.8,et),B&&(et=1);const G=w>0?y.baseY/w:0,C=Math.max(0,Math.min(1,(G+1)*.5)),Z=Math.abs(G-S),z=Math.max(0,1-Z*3),H=Math.min(255,Math.floor(M(255,180,C)+z*55)),R=Math.min(255,Math.floor(M(225,130,C)+z*40)),st=Math.min(255,Math.floor(M(50,10,C)+z*50)),O=M(y.r,H,a)/255,nt=M(y.g,R,a)/255,rt=M(y.b,st,a)/255;s.setXYZ(v,B?1:O,B?.97:nt,B?.86:rt),f.setX(v,et);const N=wt[y.char];N&&u.setXY(v,N.u,N.v);let xt=h*1.1;B&&(xt*=2.2),m.setX(v,xt)}return g.count=b,g.instanceMatrix.needsUpdate=!0,s.needsUpdate=!0,f.needsUpdate=!0,u.needsUpdate=!0,m.needsUpdate=!0,b}const dt=document.createElement("div");Object.assign(dt.style,{position:"fixed",pointerEvents:"none",opacity:"0",transition:"opacity 0.2s ease",background:"rgba(10, 10, 10, 0.92)",border:"1px solid rgba(255, 215, 0, 0.4)",borderRadius:"8px",padding:"14px 18px",textAlign:"center",fontFamily:'"Courier New", "SF Mono", monospace',zIndex:"100",backdropFilter:"blur(8px)",WebkitBackdropFilter:"blur(8px)",boxShadow:"0 0 24px rgba(255, 45, 45, 0.15), 0 0 8px rgba(255, 215, 0, 0.1)",maxWidth:"220px",minWidth:"140px"});dt.innerHTML='<div id="tt-char" style="font-size:36px;color:#FFD700;margin-bottom:6px;text-shadow:0 0 12px rgba(255,215,0,0.5)"></div><div id="tt-phrase" style="font-size:15px;color:#FF2D2D;margin-bottom:4px"></div><div id="tt-english" style="font-size:11px;color:#FFD700;opacity:0.65"></div>';document.body.appendChild(dt);function Pe(e,t,i){const n=Ut[e];if(!n){ut();return}document.getElementById("tt-char").textContent=e,document.getElementById("tt-phrase").textContent=n.phrase,document.getElementById("tt-english").textContent=n.english;const a=200,c=110;let l=t-a/2,r=i-c-30;l=Math.max(8,Math.min(window.innerWidth-a-8,l)),r<8&&(r=i+40),dt.style.left=l+"px",dt.style.top=r+"px",dt.style.opacity="1"}function ut(){dt.style.opacity="0"}function _t(e,t){if($.length===0){K=-1,ut();return}const i=Math.min(A,T)*.4*h,n=Math.min(1,(d-ht)/1.2),a=q?1:X(n),c=q?Math.min(1,(d-ht)/.6):1,l=i*.06*(q?c:a);let r=-1,s=1/0;for(let u=0;u<$.length;u++){const m=$[u];if(!Ut[m.char])continue;const x=m.origZ*a+Math.sin(d*1.5+m.phase)*l,b=Vt(m.baseX,m.baseY,x,ft),w=b.screenX-e,S=b.screenY-t,v=w*w+S*S;v<s&&(s=v,r=u)}const f=h*2.5;if(s>f*f){K=-1,ut();return}if(r!==K){K=r;const u=$[r],m=u.origZ*a+Math.sin(d*1.5+u.phase)*l,x=Vt(u.baseX,u.baseY,m,ft);Pe(u.char,x.screenX,x.screenY)}}const re=[];function Xe(){for(let e=0;e<40;e++)re.push({col:Math.random()*A,row:Math.random()*T,vx:(Math.random()-.5)*.02,vy:(Math.random()-.5)*.02,char:W[Math.floor(Math.random()*W.length)],alpha:.03+Math.random()*.08,phase:Math.random()*Math.PI*2,changeTimer:Math.random()*200})}Xe();function Wt(e){for(const t of re){t.col+=t.vx,t.row+=t.vy,t.changeTimer--,t.col<0&&(t.col+=A),t.col>=A&&(t.col-=A),t.row<0&&(t.row+=T),t.row>=T&&(t.row-=T),t.changeTimer<=0&&(t.char=W[Math.floor(Math.random()*W.length)],t.changeTimer=100+Math.random()*200);const i=Math.floor(t.col),n=Math.floor(t.row),a=t.alpha+Math.sin(t.phase+e*1.5)*.02;se(i,n,999,t.char,255,215,0,Math.max(.01,a))}}function Ge(){o.save(),o.globalAlpha=.03,o.fillStyle="#fff";for(let e=0;e<Y.height;e+=4*F)o.fillRect(0,e,Y.width,1*F);o.restore()}function We(){o.save(),o.scale(F,F),o.fillStyle=p.bg,o.fillRect(0,0,window.innerWidth,window.innerHeight);const e=h;o.font=`${e}px ${Et}, "Courier New", "SF Mono", monospace`,o.textAlign="center",o.textBaseline="middle";for(let t=0;t<T;t++)for(let i=0;i<A;i++){const n=Rt[t*A+i];if(!n)continue;const a=ae+i*h+h/2,c=Ft+t*h+h/2;n.alpha>.3?(o.shadowColor=`rgba(${n.r}, ${n.g}, ${n.b}, ${n.alpha*.6})`,o.shadowBlur=h*n.alpha*1.2):(o.shadowColor="transparent",o.shadowBlur=0),o.fillStyle=`rgba(${n.r}, ${n.g}, ${n.b}, ${n.alpha})`,o.fillText(n.char,a,c)}o.shadowBlur=0,o.shadowColor="transparent",o.restore(),Ge()}function Ye(e){o.save(),o.scale(F,F);const i=Math.min(window.innerWidth,window.innerHeight)*.55,n=window.innerWidth/2,a=window.innerHeight/2;o.textAlign="center",o.textBaseline="middle",o.font=`${i}px ${Et}, serif`,o.globalAlpha=e*.3,o.shadowColor=p.glowGold,o.shadowBlur=i*.15,o.fillStyle=p.glowGold,o.fillText("福",n,a),o.globalAlpha=e,o.shadowColor=p.glowGold,o.shadowBlur=i*.06,o.fillStyle=p.glowGold,o.fillText("福",n,a),o.shadowBlur=0,o.restore()}function L(e,t,i,n,a,c){o.save(),o.scale(F,F);const l=a||Math.max(12,h*1.2),r=c||'"Courier New", "SF Mono", monospace';o.font=`${l}px ${r}`,o.textAlign="center",o.textBaseline="middle",o.fillStyle=i||p.glowGreen,o.globalAlpha=n??.6,o.shadowColor=i||p.glowGreen,o.shadowBlur=l*.4,o.fillText(e,window.innerWidth/2,window.innerHeight*t),o.shadowBlur=0,o.restore()}function Ht(){!tt||!Dt||!ot||(tt.render(Dt,ot),o.save(),o.setTransform(1,0,0,1,0,0),o.globalCompositeOperation="lighter",o.drawImage(tt.domElement,0,0),o.restore())}const E=new me;function ie(e){if(!g)return;if(!e.length){g.count=0;return}const t=g.geometry.attributes.instanceColor,i=g.geometry.attributes.instanceAlpha,n=g.geometry.attributes.instanceUV,a=g.geometry.attributes.instanceScale,c=g.geometry.getAttribute("instanceColor").count,l=Math.min(e.length,c);for(let r=0;r<l;r++){const s=e[r];E.position.set(s.x,-s.y,-s.z),E.updateMatrix(),g.setMatrixAt(r,E.matrix),t.setXYZ(r,s.r/255,s.g/255,s.b/255),i.setX(r,s.alpha);const f=wt[s.char];f&&n.setXY(r,f.u,f.v),a.setX(r,h*(s.size||1))}g.count=l,g.instanceMatrix.needsUpdate=!0,t.needsUpdate=!0,i.needsUpdate=!0,n.needsUpdate=!0,a.needsUpdate=!0,Ht()}let j="arrival",D=0,d=0,le=0,mt=null;function ce(e){j=e,le=d,D=0,e==="draw"&&He(),e==="fortune"&&(mt&&mt.length>0?(Qt(mt),mt=null):Qt(),ne()),e==="fireworks"&&(K=-1,ut(),ne())}function ke(){Wt(d)}function Ie(){const e=Math.min(1,D/1);Ye(e);const t=Math.min(1,D/1.5);L("新年纳福",.15,p.glowGold,t*.8,h*2),L("A Blessing Awaits",.2,p.glowGold,t*.5,h*1.1);const i=Math.min(1,Math.max(0,(D-1.5)/.5)),n=.4+Math.sin(d*3)*.2,a=d%3;let c=0;if(a<.9){const l=1-a/.9;c=-Math.abs(Math.sin(a/.9*Math.PI*3))*.012*l}L("↑  上滑抽签  ↑",.88+c,p.glowGold,i*n,h*1.6),L("Swipe Up to Draw Fortune",.92+c,p.glowGold,i*n,h*1.1)}let Mt=[],it=[],lt=0;const k=p.fuExplodeDelay,he=p.fuRiseDuration,Le=p.fuShrinkDuration,Ue=p.fuShrinkEndScale,te=p.fuCameraPullbackDuration,_e=p.fuCameraReturnDuration,I=k+1.2,_=I+1.1,It=_+.4;function He(){if(Mt=[],it=[],lt=0,mt=null,!Gt)return;const e=Math.min(A,T)*.4*h,t=e*.4,i=Xt.map(a=>({x:a.nx*e*.5*a.aspect,y:a.ny*e*.5,z:(Math.random()-.5)*t,brightness:a.brightness})),n=zt(A/2,T*.22);for(let a=0;a<i.length;a++){const c=i[a],l=Math.random()*Math.PI*2,r=e*(.8+Math.random()*1.2),s=e*(.1+Math.random()*.4);Mt.push({x:n.x,y:n.y,z:0,startX:n.x,startY:n.y,startZ:0,scatterX:n.x+Math.cos(l)*r,scatterY:n.y+Math.sin(l)*r*.6+s,scatterZ:(Math.random()-.5)*t*1.6,targetX:c.x,targetY:c.y,targetZ:c.z,char:W[Math.floor(Math.random()*W.length)],scrambleTimer:0,finalChar:Bt(c.brightness),brightness:c.brightness,phase:Math.random()*Math.PI*2,active:!1})}}function $e(){Wt(d);const e=D;if(e<k){const n=Math.min(1,e/Math.max(.001,he)),a=X(n),c=M(T*.5,T*.22,a),l=A/2,r=zt(l,c);Math.random()<.6&&it.push({x:r.x+(Math.random()-.5)*h*4,y:r.y+h*(.9+Math.random()*2.2),z:(Math.random()-.5)*h*3,vx:(Math.random()-.5)*h*.08,vy:h*(.08+Math.random()*.12),vz:(Math.random()-.5)*h*.06,char:W[Math.floor(Math.random()*W.length)],life:1,decay:.015+Math.random()*.025})}if(e>=k&&e<k+.15){lt=1-(e-k)/.15;for(const n of Mt)n.active=!0}else e>=k+.15&&(lt=0);if(e>=k){for(const n of Mt)if(n.active)if(e<I){const a=(e-k)/(I-k),c=1-Math.pow(1-a,2);n.x=M(n.startX,n.scatterX,c),n.y=M(n.startY,n.scatterY,c)+c*h*6,n.z=M(n.startZ,n.scatterZ,c);const l=a*h*.8;n.x+=Math.sin(n.phase+d*4)*l,n.y+=Math.cos(n.phase+d*3)*l,n.z+=Math.sin(n.phase*.7+d*3.2)*l*1.4,n.scrambleTimer-=1,n.scrambleTimer<=0&&(n.char=W[Math.floor(Math.random()*W.length)],n.scrambleTimer=2+Math.random()*3)}else if(e<_){const a=(e-I)/(_-I),c=X(a);n.x=M(n.scatterX,n.targetX,c),n.y=M(n.scatterY+h*6,n.targetY,c),n.z=M(n.scatterZ,n.targetZ,c);const l=(1-c)*h*.8;n.x+=Math.sin(n.phase+d*4)*l,n.y+=Math.cos(n.phase+d*3)*l,n.z+=Math.sin(n.phase*.7+d*3.2)*l*1.4,n.scrambleTimer-=1,n.scrambleTimer<=0&&(n.char=a>.4?n.finalChar:W[Math.floor(Math.random()*W.length)],n.scrambleTimer=2+a*12)}else{const a=Math.min(1,(e-_)/Math.max(.001,It-_)),c=X(a);n.x=M(n.x,n.targetX,c),n.y=M(n.y,n.targetY,c),n.z=M(n.z,n.targetZ,c),n.char=n.finalChar}}const t=(T*.5+2)*h;let i=0;for(let n=0;n<it.length;n++){const a=it[n];a.x+=a.vx,a.y+=a.vy,a.z+=a.vz,a.vx*=.98,a.vz*=.98,a.life-=a.decay,a.life>0&&a.y<t&&(it[i++]=a)}if(it.length=i,e>=It+.3){const n=je();mt=n.length>0?n:null,ce("fortune")}}function je(){const e=[];for(const t of Mt){if(!t.active)continue;const i=Math.min(1,t.brightness+.08),n=t.finalChar||Bt(i);if(n===" ")continue;const a=Pt(i);e.push({baseX:t.x,baseY:t.y,origZ:t.targetZ,char:n,r:a.r,g:a.g,b:a.b,alpha:.3+i*.7,lum:i,phase:t.phase})}return e}function Ze(e){const t=[];for(const a of it)t.push({x:a.x,y:a.y,z:a.z,char:a.char,r:255,g:Math.floor(190+a.life*65),b:Math.floor(35+a.life*40),alpha:a.life*.68,size:.72+a.life*.35,glow:.9,blur:.8});const n=Math.min(A,T)*.4*h*.06;for(const a of Mt){if(!a.active)continue;const c=a.brightness,l=255,r=180+c*75,s=c*50;let f=l,u=r,m=s,x,b=.95+c*.45;if(e<I){const P=1-(e-k)/(I-k),B=Math.sin(d*25+a.phase*3)*.25*P;x=Math.min(1,Math.max(.1,.6+c*.3+B));const U=Math.sin(d*18+a.phase*2)*.3*P;b*=1+U}else if(e<_){const P=(e-I)/(_-I),B=Math.sin(d*8+a.phase)*.2*P;x=Math.min(1,Math.max(.2,.6+c*.3+B));const U=Math.sin(d*6+a.phase)*.15*P;b*=1+U}else{const y=Math.min(1,(e-_)/(It-_)),P=Math.min(1,c+.08),B=Pt(P);f=M(l,B.r,y),u=M(r,B.g,y),m=M(s,B.b,y);const U=.3+P*.7,et=Math.min(1,(.5+c*.5)*(1+Math.sin(y*Math.PI)*.3));x=M(et,U,y),b=M(b,1.1,y)}let w=0;if(e>=_)w=1;else if(e>I){const y=(e-I)/(_-I);w=Math.max(0,y-.5)*2}const S=Math.sin(d*1.5+a.phase)*n,v=a.z+S*w;t.push({x:a.x,y:a.y,z:v,char:a.char,r:Math.round(f),g:Math.round(u),b:Math.round(m),alpha:x,size:b,glow:.7,blur:.65})}ie(t)}function Oe(){const e=D;if(Ze(e),e<k){const t=Math.min(1,e/Math.max(.001,he)),i=Math.min(1,e/Math.max(.001,Le)),n=X(t),a=X(i);o.save(),o.scale(F,F);const r=Math.min(window.innerWidth,window.innerHeight)*.55*M(1,Ue,a),s=window.innerWidth/2,f=window.innerHeight*M(.5,.2,n);o.textAlign="center",o.textBaseline="middle",o.font=`${r}px ${Et}, serif`;const u=1+t*2.5;o.globalAlpha=Math.min(1,.3*u),o.shadowColor=p.glowGold,o.shadowBlur=r*.2*u,o.fillStyle=p.glowGold,o.fillText("福",s,f),o.globalAlpha=1,o.shadowBlur=r*.08*u,o.fillText("福",s,f),o.shadowBlur=0,o.restore()}if(lt>0){o.save(),o.scale(F,F);const t=window.innerWidth/2,i=window.innerHeight*.22,n=Math.min(window.innerWidth,window.innerHeight)*.4*lt,a=o.createRadialGradient(t,i,0,t,i,n);a.addColorStop(0,`rgba(255, 255, 220, ${lt*.8})`),a.addColorStop(.4,`rgba(255, 215, 0, ${lt*.4})`),a.addColorStop(1,"rgba(255, 215, 0, 0)"),o.fillStyle=a,o.fillRect(0,0,window.innerWidth,window.innerHeight),o.restore()}}function Ne(e){const t=Math.min(A,T)*.4,i=A/2,n=T/2;for(const a of Xt){const c=Math.floor(i+a.nx*t*.5*a.aspect),l=Math.floor(n+a.ny*t*.5),r=Math.min(1,a.brightness+.08),s=Bt(r);if(s===" ")continue;const f=Pt(r);se(c,l,0,s,f.r,f.g,f.b,Math.min(1,(.3+r*.7)*e))}}function Ve(){Wt(d),fe(),!pt&&D>6&&d-kt>De&&(kt=d,Ct(1))}function qe(e,t,i,n,a){const l=i*1.5;for(let r=0;r<14;r++){const s=r*137.508,f=(n*2.5+r/14)%1,u=Math.sin(f*Math.PI)*a*.6;if(u<.02)continue;const m=s+d*(1.2+r%3*.4),x=l*(.15+f*.85),b=e+Math.cos(m)*x,w=t+Math.sin(m)*x*.3,S=1+(1-f)*2.5;o.globalAlpha=u,o.fillStyle=p.glowGold,o.shadowColor=p.glowGold,o.shadowBlur=S*5,o.beginPath(),o.arc(b,w,S,0,Math.PI*2),o.fill()}}function Ke(e,t){const i=h*5,n=1.3,a=window.innerWidth/2,c=window.innerHeight*.15,l=["大","吉"];if(e>=n){L("大 吉",.15,p.glowGold,.9,h*5,t);return}o.save(),o.scale(F,F),o.font=`${i}px ${t}, serif`,o.textAlign="center",o.textBaseline="middle";const r=o.measureText("大 吉").width,s=o.measureText("大").width,f=o.measureText("吉").width,u=[a-r/2+s/2,a+r/2-f/2];for(let m=0;m<l.length;m++){const x=m*.2,b=n-x-.1,w=Math.max(0,Math.min(1,(e-x)/b));if(w<=0)continue;let S;w<.35?S=M(1.8,.93,X(w/.35)):w<.6?S=M(.93,1.06,X((w-.35)/.25)):S=M(1.06,1,X((w-.6)/.4));const v=Math.min(.9,w*3),y=1+Math.max(0,1-w*1.5)*2.5,P=Math.max(0,1-w*2.5)*i*.1;o.save(),o.translate(u[m],c+P),o.scale(S,S),o.globalAlpha=v*.35*y,o.fillStyle=p.glowGold,o.shadowColor=p.glowGold,o.shadowBlur=i*.25*y,o.fillText(l[m],0,0),o.globalAlpha=v,o.shadowBlur=i*.12,o.fillText(l[m],0,0),o.restore()}o.shadowBlur=0,o.shadowColor="transparent",o.restore()}function Je(e,t,i,n){o.save(),o.scale(F,F);const a=h*5,c=window.innerWidth/2,l=window.innerHeight*.15,r=t*.9,s=["大","吉"];o.font=`${a}px ${i}, serif`,o.textAlign="center",o.textBaseline="middle";const f=o.measureText("大 吉").width,u=o.measureText("大").width,m=o.measureText("吉").width,x=[c-f/2+u/2,c+f/2-m/2];o.font=`${a}px ${n}, serif`;const b=o.measureText("大 吉").width,w=o.measureText("大").width,S=o.measureText("吉").width,v=[c-b/2+w/2,c+b/2-S/2],y=.3,P=.1,B=.7,U=.45,et=e<.15?e/.15:e>.85?(1-e)/.15:1;if(qe(c,l,a,e,r*et),e<y){const G=e/y;o.font=`${a}px ${i}, serif`,o.textAlign="center",o.textBaseline="middle";for(let C=0;C<s.length;C++){const Z=C*.2,z=Math.max(0,Math.min(1,(G-Z)/(1-Z))),H=Math.sin(d*35+C*2.7)*z*a*.05,R=Math.cos(d*28+C*1.9)*z*a*.035,st=-z*z*a*.1,O=r*(1-z*z),nt=z*a*.025,rt=x[C]+H,N=l+R+st;nt>.5&&(o.globalAlpha=O*.3,o.fillStyle="#FF4444",o.shadowColor="#FF4444",o.shadowBlur=a*.12,o.fillText(s[C],rt-nt,N),o.fillStyle="#FFEE44",o.shadowColor="#FFEE44",o.fillText(s[C],rt+nt,N+nt*.3)),o.globalAlpha=O,o.fillStyle=p.glowGold,o.shadowColor=p.glowGold,o.shadowBlur=a*(.15+z*.25),o.fillText(s[C],rt,N)}}if(e>=P&&e<B){const G=(e-P)/(B-P),C=M(18,3,G*G),Z=Math.floor(d*C),z=X(G),H=G<.15?G/.15:G>.7?(1-G)/.3:1;o.font=`${a}px ${G<.5?i:n}, serif`,o.textAlign="center",o.textBaseline="middle";for(let R=0;R<s.length;R++){const st=W[(Z+R*13)%W.length],O=Math.sin(d*5+R*2)*a*.035,nt=Math.cos(d*3.5+R*2.5)*a*.02,rt=M(x[R],v[R],z)+nt,N=l+O,xt=1+Math.sin(d*8+R)*.05;o.save(),o.translate(rt,N),o.scale(xt,xt),o.globalAlpha=r*H*.7,o.fillStyle=p.glowGold,o.shadowColor=p.glowGold,o.shadowBlur=a*.2,o.fillText(st,0,0),o.restore()}}if(e>=U){const G=(e-U)/(1-U);o.font=`${a}px ${n}, serif`,o.textAlign="center",o.textBaseline="middle";for(let C=0;C<s.length;C++){const Z=C*.15,z=Math.max(0,Math.min(1,(G-Z)/(1-Z))),H=X(z);let R;z<.45?R=H/.45*1.1:z<.7?R=M(1.1,.97,X((z-.45)/.25)):R=M(.97,1,X((z-.7)/.3));const st=(1-H)*a*.12,O=1+Math.sin(z*Math.PI)*.5;o.save(),o.translate(v[C],l+st),o.scale(R,R),o.globalAlpha=r*H*.35*O,o.fillStyle=p.glowGold,o.shadowColor=p.glowGold,o.shadowBlur=a*.3*O,o.fillText(s[C],0,0),o.globalAlpha=r*H,o.shadowBlur=a*.12,o.fillText(s[C],0,0),o.restore()}}o.shadowBlur=0,o.shadowColor="transparent",o.restore()}function Qe(){const e=Be();J.length||V.length||Q.length?an(e):Ht();const t=Math.min(1,D/.9);if(pt){const a=(d-pt.startTime)/1.2;a>=1?(pt=null,L("大 吉",.15,p.glowGold,t*.9,h*5,yt())):Je(a,t,pt.oldFont,yt())}else D<1.5?Ke(D,yt()):L("大 吉",.15,p.glowGold,t*.9,h*5,yt());const i=Math.min(1,Math.max(0,(D-.5)/.9));L("万事如意 · 心想事成",.82,p.glowRed,i*.7,h*1.5),L("May all your wishes come true",.87,p.glowGold,i*.5,h*1)}const ee=[{chars:"福禄寿喜财",r:255,g:45,b:45},{chars:"财富贵发金玉宝余丰盛利旺",r:255,g:215,b:0},{chars:"安康宁泰和平顺健",r:0,g:255,b:159},{chars:"喜乐欢庆禧祺嘉春",r:255,g:120,b:80},{chars:"德善仁义忠信孝慧恩",r:255,g:200,b:50},{chars:"爱合圆满美馨雅",r:255,g:130,b:180},{chars:"吉祥瑞如意祝运",r:180,g:255,b:80},{chars:"龙凤麟鹤华",r:255,g:180,b:50},{chars:"成升登高",r:80,g:220,b:255}],J=[],V=[],Q=[];let Tt=0,$t=0;function de(){const e=ee[Math.floor(Math.random()*ee.length)],t=A*(.15+Math.random()*.7),i=t+(Math.random()-.5)*A*.12,n=zt(t,T+2),a=zt(i,T*(.1+Math.random()*.3)),c=(Math.random()-.5)*h*8;J.push({x:n.x,y:n.y,z:c,startX:n.x,startY:n.y,startZ:c,targetX:a.x,targetY:a.y,targetZ:(Math.random()-.5)*h*12,launchTime:d,duration:p.shellRiseDuration*(.85+Math.random()*.3),cat:e}),$t++}function tn(e){const t=25+Math.floor(Math.random()*35),{chars:i,r:n,g:a,b:c}=e.cat;for(let l=0;l<t;l++){const r=Math.PI*2*l/t+(Math.random()-.5)*.4,s=h*(.06+Math.random()*.1);Q.push({x:e.x,y:e.y,z:e.z,vx:Math.cos(r)*s,vy:Math.sin(r)*s-h*.06,vz:(Math.random()-.5)*s*.5,char:i[Math.floor(Math.random()*i.length)],r:n,g:a,b:c,life:.6+Math.random()*.3,decay:.008+Math.random()*.008,gravity:h*(.001+Math.random()*.001),drag:.985,trailSegs:[],lastTrailTime:d})}}function ne(){J.length=0,V.length=0,Q.length=0,Tt=0,$t=0;for(let e=0;e<2;e++)de()}function fe(){Tt--,Tt<=0&&(de(),Tt=$t<3?40+Math.random()*30:70+Math.random()*80);const e=A*h*.5,t=T*h*.5;let i=0;for(let r=0;r<J.length;r++){const s=J[r],f=(d-s.launchTime)/s.duration,u=1-Math.pow(1-Math.min(f,1),2);s.x=M(s.startX,s.targetX,u),s.y=M(s.startY,s.targetY,u),s.z=M(s.startZ,s.targetZ,u);const m=Math.max(1,Math.floor((1-u)*2.8));for(let x=0;x<m;x++)V.push({x:s.x+(Math.random()-.5)*h*.35,y:s.y+h*(.12+Math.random()*.32),z:s.z+(Math.random()-.5)*h*.6,vx:(Math.random()-.5)*h*.03,vy:h*(.07+Math.random()*.04),vz:(Math.random()-.5)*h*.03,char:"·",r:s.cat.r,g:s.cat.g,b:s.cat.b,life:.35+Math.random()*.45,decay:.03+Math.random()*.04});f>=1?tn(s):J[i++]=s}J.length=i;let n=0;for(let r=0;r<V.length;r++){const s=V[r];s.x+=s.vx,s.y+=s.vy,s.z+=s.vz,s.vx*=.95,s.vz*=.95,s.life-=s.decay,s.life>0&&s.y<=t+h*3&&(V[n++]=s)}V.length=n;const a=.06,c=14;let l=0;for(let r=0;r<Q.length;r++){const s=Q[r];s.vx*=s.drag,s.vy*=s.drag,s.vz*=s.drag,s.vy+=s.gravity,s.x+=s.vx,s.y+=s.vy,s.z+=s.vz,s.life-=s.decay,d-s.lastTrailTime>=a&&s.life>.05&&(s.trailSegs.push({x:s.x,y:s.y,z:s.z}),s.lastTrailTime=d,s.trailSegs.length>c&&s.trailSegs.shift()),s.life>0&&s.y<=t+h*6&&s.x>=-e-h*8&&s.x<=e+h*8&&s.z>=-ft*.9&&s.z<=ft*1.5&&(Q[l++]=s)}Q.length=l}function en(){Wt(d),Ne(.15+Math.sin(d*.8)*.05),fe()}function nn(){const e=[];for(const t of J)e.push({x:t.x,y:t.y,z:t.z,char:"·",r:t.cat.r,g:t.cat.g,b:t.cat.b,alpha:.9,size:1,glow:1,blur:.9});for(const t of V)e.push({x:t.x,y:t.y,z:t.z,char:t.char,r:t.r,g:t.g,b:t.b,alpha:t.life*.7,size:.7+t.life*.3,glow:.9,blur:.85});for(const t of Q){const i=Math.max(.05,t.life*t.life);e.push({x:t.x,y:t.y,z:t.z,char:t.char,r:t.r,g:t.g,b:t.b,alpha:i,size:.92+i*.5,glow:.65,blur:.62});const n=t.trailSegs.length;for(let a=0;a<n;a++){const c=t.trailSegs[a],l=n>1?a/(n-1):1,r=i*(.2+l*.6);e.push({x:c.x,y:c.y,z:c.z,char:t.char,r:t.r,g:t.g,b:t.b,alpha:r,size:.6+l*.35,glow:.5,blur:.5})}}ie(e)}function an(e){if(!g)return;const t=g.geometry.attributes.instanceColor,i=g.geometry.attributes.instanceAlpha,n=g.geometry.attributes.instanceUV,a=g.geometry.attributes.instanceScale,c=t.count;let l=e;for(const r of J){if(l>=c)break;E.position.set(r.x,-r.y,-r.z),E.updateMatrix(),g.setMatrixAt(l,E.matrix),t.setXYZ(l,r.cat.r/255,r.cat.g/255,r.cat.b/255),i.setX(l,.9);const s=wt["·"];s&&n.setXY(l,s.u,s.v),a.setX(l,h),l++}for(const r of V){if(l>=c)break;E.position.set(r.x,-r.y,-r.z),E.updateMatrix(),g.setMatrixAt(l,E.matrix),t.setXYZ(l,r.r/255,r.g/255,r.b/255),i.setX(l,r.life*.7);const s=wt[r.char];s&&n.setXY(l,s.u,s.v),a.setX(l,h*(.7+r.life*.3)),l++}for(const r of Q){if(l>=c)break;const s=Math.max(.05,r.life*r.life);E.position.set(r.x,-r.y,-r.z),E.updateMatrix(),g.setMatrixAt(l,E.matrix),t.setXYZ(l,r.r/255,r.g/255,r.b/255),i.setX(l,s);const f=wt[r.char];f&&n.setXY(l,f.u,f.v),a.setX(l,h*(.92+s*.5)),l++;const u=r.trailSegs.length;for(let m=0;m<u&&!(l>=c);m++){const x=r.trailSegs[m],b=u>1?m/(u-1):1,w=s*(.2+b*.6),S=h*(.6+b*.35);E.position.set(x.x,-x.y,-x.z),E.updateMatrix(),g.setMatrixAt(l,E.matrix),t.setXYZ(l,r.r/255,r.g/255,r.b/255),i.setX(l,w),f&&n.setXY(l,f.u,f.v),a.setX(l,S),l++}}g.count=l,g.instanceMatrix.needsUpdate=!0,t.needsUpdate=!0,i.needsUpdate=!0,n.needsUpdate=!0,a.needsUpdate=!0,Ht()}function on(){nn();const e=Math.min(1,D/1.5);if(L("恭喜发财",.08,p.glowGold,e*.7,h*2),L("Prosperity & Fortune",.13,p.glowGold,e*.4,h*1),D>3){const t=Math.min(1,(D-3)/.5),i=.3+Math.sin(d*3)*.2;L("↑  继续  ↑",.94,p.glowGold,t*i,h*1)}}let jt=0,Zt=0,ue=0;Y.addEventListener("touchstart",e=>{const t=e.touches[0];jt=t.clientX,Zt=t.clientY,ue=performance.now(),j==="fortune"&&_t(t.clientX,t.clientY)},{passive:!0});Y.addEventListener("touchmove",e=>{const t=e.touches[0];Math.abs(t.clientX-jt)>10||Math.abs(t.clientY-Zt)>10,j==="fortune"&&_t(t.clientX,t.clientY)},{passive:!0});Y.addEventListener("touchend",e=>{K=-1,ut();const t=e.changedTouches[0].clientX-jt,i=Zt-e.changedTouches[0].clientY,n=performance.now()-ue;j==="fortune"&&Math.abs(t)>50&&Math.abs(t)>Math.abs(i)&&n<500?Ct(t>0?1:-1):i>50&&n<500&&Yt()},{passive:!0});Y.addEventListener("mousemove",e=>{j==="fortune"&&_t(e.clientX,e.clientY)});Y.addEventListener("mouseleave",()=>{K=-1,ut()});let ge=0,Lt=!1;Y.addEventListener("mousedown",e=>{ge=e.clientY,Lt=!0});Y.addEventListener("mouseup",e=>{Lt&&ge-e.clientY>50&&Yt(),Lt=!1});Y.addEventListener("wheel",e=>{e.deltaY<-30&&Yt()},{passive:!0});window.addEventListener("keydown",e=>{(e.code==="Space"||e.code==="ArrowUp")&&(e.preventDefault(),Yt()),j==="fortune"&&(e.code==="ArrowLeft"&&(e.preventDefault(),Ct(-1)),e.code==="ArrowRight"&&(e.preventDefault(),Ct(1)))});function Yt(){j==="arrival"&&Gt&&ce("draw")}const sn=performance.now();function pe(e){switch(d=(e-sn)/1e3,D=d-le,Ee(),j){case"arrival":ke();break;case"draw":$e();break;case"fortune":Ve();break;case"fireworks":en();break}let t=0;if(j==="draw"){if(D<k)if(D<te){const i=Math.min(1,D/Math.max(.001,te));t=-X(i)*h*3}else t=-h*3;else{const i=Math.min(1,(D-k)/Math.max(.001,_e));t=-(1-X(i))*h*3}Ft+=t}switch(We(),t!==0&&(Ft-=t),g&&(g.count=0),j){case"arrival":Ie();break;case"draw":Oe();break;case"fortune":Qe();break;case"fireworks":on();break}requestAnimationFrame(pe)}requestAnimationFrame(pe);
