import"./modulepreload-polyfill-B5Qt9EMX.js";import{O as ve,aj as Se,E as Te,ai as Ae,az as Ce,m as te,ay as ze,al as Ie,V as Ee,aA as De,aB as ee,aC as Fe,I as Pe,i as Ct}from"./three.module-aEEDt9MZ.js";const We=[{date:"2025-02-01",wish:"World Peace"},{date:"2025-02-08",wish:"A healthy year for my family"},{date:"2025-02-14",wish:"To finish my novel"}];class Be{constructor(t){this.callbacks=t;const n=new URLSearchParams(window.location.search).get("id");this.isPhysical=!!n,this.id=n||"demo",this.state=this.loadState(),this.ui={overlay:document.getElementById("envelope-overlay"),startPanel:document.getElementById("panel-start"),wishPanel:document.getElementById("panel-wish"),resultPanel:document.getElementById("panel-result"),historyList:document.getElementById("history-list"),wishInput:document.getElementById("wish-input"),btcDisplay:document.getElementById("btc-display"),finalWish:document.getElementById("final-wish")},this.init()}loadState(){try{if(this.id==="sealed"&&!localStorage.getItem(`fu_envelope_${this.id}`))return{opened:!0,wished:!0,myWish:"happy"};const t=localStorage.getItem(`fu_envelope_${this.id}`);return t?JSON.parse(t):{opened:!1,wished:!1,myWish:null}}catch(t){return console.warn("Failed to load state",t),{opened:!1,wished:!1,myWish:null}}}loadHistory(){try{const t=localStorage.getItem(`fu_history_${this.id}`);return t?JSON.parse(t):[]}catch{return[]}}saveState(){localStorage.setItem(`fu_envelope_${this.id}`,JSON.stringify(this.state))}saveHistory(t){localStorage.setItem(`fu_history_${this.id}`,JSON.stringify(t))}init(){this.renderHistory(),document.getElementById("btn-open").addEventListener("click",()=>this.handleOpen()),document.getElementById("btn-submit-wish").addEventListener("click",()=>this.handleWish()),document.getElementById("btn-reset").addEventListener("click",()=>this.handleReset()),this.ui.overlay.addEventListener("click",t=>{t.target===this.ui.overlay&&this.hideAllPanels()}),this.state.wished&&(this.ui.finalWish.textContent=this.state.myWish,this.ui.btcDisplay.classList.add("show"))}hideAllPanels(){["start","wish","result"].forEach(t=>{document.getElementById(`panel-${t}`).classList.remove("active")})}renderHistory(){const t=this.ui.historyList;if(t.innerHTML="",!this.isPhysical){t.innerHTML=`
                <div class="history-item" style="border:none; text-align:center; opacity:0.6; font-style:italic; padding-top:1rem;">
                    Demo Mode<br>
                    <span style="font-size:0.7em">Scan a physical artifact to view its history.</span>
                </div>`;return}const i=this.loadHistory();[...We,...i].forEach(a=>{const c=document.createElement("div");c.className="history-item",c.innerHTML=`
                <span class="history-date">${a.date}</span>
                <span class="history-wish">"${a.wish}"</span>
            `,t.appendChild(c)})}showPanel(t){["start","wish","result"].forEach(i=>{const n=document.getElementById(`panel-${i}`);n.classList.remove("active"),i===t&&setTimeout(()=>n.classList.add("active"),10)})}handleOpen(){this.state.opened=!0,this.saveState(),document.getElementById("panel-start").classList.remove("active"),this.callbacks.onOpen&&this.callbacks.onOpen()}showWishInput(){this.showPanel("wish")}handleWish(){const t=this.ui.wishInput.value.trim();t&&(this.state.wished=!0,this.state.myWish=t,this.saveState(),this.ui.finalWish.textContent=t,this.showPanel("result"),this.isPhysical&&setTimeout(()=>{this.ui.btcDisplay.classList.add("show")},500),this.callbacks.onWish&&this.callbacks.onWish())}handleReset(){if(this.state.myWish){const t=this.loadHistory(),i=new Date().toISOString().split("T")[0];t.push({date:i,wish:this.state.myWish}),this.saveHistory(t)}this.state={opened:!1,wished:!1,myWish:null},this.saveState(),this.ui.wishInput.value="",this.ui.btcDisplay.classList.remove("show"),location.reload()}}const Re=`// Particle vertex shader — billboarded instanced quads
// Uses instanceMatrix from Three.js InstancedMesh (set via setMatrixAt)

attribute vec3 instanceColor;     // RGB normalized 0-1
attribute float instanceAlpha;
attribute vec2 instanceUV;        // atlas cell UV offset
attribute float instanceScale;    // quad size in world units

uniform vec2 cellSize;            // UV size of one atlas cell (1/cols, 1/rows)

varying vec2 vUv;
varying vec3 vColor;
varying float vAlpha;

void main() {
    // Extract world position from instanceMatrix (translation column)
    vec4 worldPos = instanceMatrix * vec4(0.0, 0.0, 0.0, 1.0);

    // Transform to view space
    vec4 mvPosition = modelViewMatrix * worldPos;

    // Billboard: expand unit quad in view space (always faces camera)
    mvPosition.xy += position.xy * instanceScale;

    gl_Position = projectionMatrix * mvPosition;

    // Map quad UV (0..1) into this character's atlas cell
    vUv = instanceUV + uv * cellSize;
    vColor = instanceColor;
    vAlpha = instanceAlpha;
}
`,Le=`// Particle fragment shader — samples character atlas, applies color tint
// Atlas: white chars with baked glow on BLACK background (R channel = intensity)
// Output: premultiplied alpha for additive blending

uniform sampler2D atlas;

varying vec2 vUv;
varying vec3 vColor;
varying float vAlpha;

void main() {
    float raw = texture2D(atlas, vUv).r;
    float intensity = pow(raw, 0.75); // Lift dim glow fringe for softer halo
    float alpha = intensity * vAlpha;
    if (alpha < 0.01) discard;

    // Premultiplied color for additive blending (src + dst)
    gl_FragColor = vec4(vColor * alpha, alpha);
}
`,X=document.getElementById("c"),o=X.getContext("2d");let N;const u={bg:"#990000",glowRed:"#FF2D2D",glowGold:"#FFD700",glowGreen:"#00FF9F",scatterDur:450,scrambleDur:900,convergeDur:450,settleDur:250,fuExplodeDelay:2,fuRiseDuration:.8,fuShrinkDuration:.8,fuShrinkEndScale:.18,fuCameraPullbackDuration:.45,fuCameraReturnDuration:.7,shellRiseDuration:2.5},Tt=[" ","·","一","人","十","大","吉","平","安","和","春","利","兴","旺","发","金","贵","富","财","寿","禄","喜","龙","凤","福"],L="福禄寿喜财富贵发金玉宝余丰盛利旺隆昌兴进安康宁泰和平顺健乐欢庆禧祺嘉春德善仁义忠信孝慧恩爱合圆满美馨雅吉祥瑞如意祝运龙凤麟鹤华成升登高",Vt={一:{phrase:"一帆风顺",english:"Smooth sailing in all endeavors"},人:{phrase:"人寿年丰",english:"Long life and abundant harvests"},十:{phrase:"十全十美",english:"Perfection in every way"},大:{phrase:"大吉大利",english:"Great luck and great profit"},吉:{phrase:"吉祥如意",english:"Good fortune as you wish"},平:{phrase:"四季平安",english:"Peace through all four seasons"},安:{phrase:"岁岁平安",english:"Peace and safety year after year"},和:{phrase:"和气生财",english:"Harmony brings prosperity"},春:{phrase:"春风得意",english:"Success on the spring breeze"},利:{phrase:"开岁大利",english:"Great profit in the new year"},兴:{phrase:"兴旺发达",english:"Flourishing and thriving"},旺:{phrase:"人丁兴旺",english:"A growing and prosperous family"},发:{phrase:"恭喜发财",english:"Wishing you great prosperity"},金:{phrase:"金玉满堂",english:"Gold and jade fill the hall"},贵:{phrase:"荣华富贵",english:"Glory, splendor, and riches"},富:{phrase:"富贵有余",english:"Wealth and abundance to spare"},财:{phrase:"财源广进",english:"Wealth flowing from all directions"},寿:{phrase:"福寿双全",english:"Both blessings and longevity"},禄:{phrase:"高官厚禄",english:"High rank and generous reward"},喜:{phrase:"双喜临门",english:"Double happiness at the door"},龙:{phrase:"龙马精神",english:"The vigor of dragons and horses"},凤:{phrase:"龙凤呈祥",english:"Dragon and phoenix bring fortune"},福:{phrase:"福星高照",english:"The star of fortune shines bright"}},O=['"Zhi Mang Xing"','"Liu Jian Mao Cao"','"Ma Shan Zheng"','"TsangerZhoukeZhengdabangshu"','"hongleixingshu"','"qiantubifengshouxieti"','"峄山碑篆体"'],Lt=O[Math.floor(Math.random()*O.length)];let It=0,yt=null,$t=0;const ke=4.5;function zt(){return O[It]}function Dt(e){const t=O[It];let i;do i=Math.floor(Math.random()*O.length);while(i===It&&O.length>1);It=i,yt={oldFont:t,startTime:d},$t=d}function y(e,t,i){return e+(t-e)*i}function B(e){return e<.5?2*e*e:-1+(4-2*e)*e}const wt=500;function ne(e,t,i,n){const a=n/(n+i);return{screenX:e*a+window.innerWidth/2,screenY:t*a+window.innerHeight/2,scale:a}}function Ft(e,t){return{x:(e-T/2)*h,y:(t-A/2)*h}}let h,T,A,ae,oe,he,Pt,E=Math.min(window.devicePixelRatio||1,2),ot,Wt,ct,p,st={};function de(){E=Math.min(window.devicePixelRatio||1,2),X.width=window.innerWidth*E,X.height=window.innerHeight*E,X.style.width=window.innerWidth+"px",X.style.height=window.innerHeight+"px";const e=Math.min(window.innerWidth,window.innerHeight);if(h=Math.max(10,Math.floor(e*.028)),T=Math.floor(window.innerWidth/h),A=Math.floor(window.innerHeight/h),ae=T*h,oe=A*h,he=(window.innerWidth-ae)/2,Pt=(window.innerHeight-oe)/2,ot){ot.setSize(window.innerWidth,window.innerHeight),ot.setPixelRatio(E);const t=2*Math.atan(window.innerHeight/(2*wt))*(180/Math.PI);ct.fov=t,ct.aspect=window.innerWidth/window.innerHeight,ct.updateProjectionMatrix()}}window.addEventListener("resize",de);de();const Z=20,Mt=20,H=64;function Xe(){ot=new Se({alpha:!0,antialias:!1}),ot.setSize(window.innerWidth,window.innerHeight),ot.setPixelRatio(E);const e=2*Math.atan(window.innerHeight/(2*wt))*(180/Math.PI);ct=new Te(e,window.innerWidth/window.innerHeight,1,3e3),ct.position.set(0,0,wt),ct.lookAt(0,0,0),Wt=new Ae;const t=document.createElement("canvas");t.width=Z*H,t.height=Mt*H;const i=t.getContext("2d");i.fillStyle="#000",i.fillRect(0,0,t.width,t.height);const n=new Set([...Tt,...L.split(""),...Object.keys(Vt),"·"]);i.font=`bold ${Math.floor(H*.7)}px "Courier New", "SF Mono", monospace`,i.textAlign="center",i.textBaseline="middle",i.fillStyle="#FFFFFF",i.shadowColor="white",i.shadowBlur=H*.12;let a=0;n.forEach(m=>{if(a>=Z*Mt)return;const S=a%Z,v=Math.floor(a/Z),M=S*H+H/2,D=v*H+H/2;i.fillText(m,M,D),st[m]={u:S/Z,v:1-(v+1)/Mt},a++});const c=Tt.filter(m=>m!==" ");for(let m=0;m<O.length;m++){i.font=`bold ${Math.floor(H*.7)}px ${O[m]}, "Courier New", monospace`;for(const S of c){if(a>=Z*Mt)break;const v=a%Z,M=Math.floor(a/Z),D=v*H+H/2,F=M*H+H/2;i.fillText(S,D,F),st[S+"|"+m]={u:v/Z,v:1-(M+1)/Mt},a++}}const l=new Ce(t);l.magFilter=te,l.minFilter=te;const r=4e3,s=new ze(1,1),f=new Ie({uniforms:{atlas:{value:l},cellSize:{value:new Ee(1/Z,1/Mt)}},vertexShader:Re,fragmentShader:Le,transparent:!0,blending:De,blendSrc:ee,blendDst:ee,blendEquation:Fe,depthWrite:!1,depthTest:!1});p=new Pe(s,f,r);const g=new Float32Array(r*3),w=new Float32Array(r),x=new Float32Array(r*2),b=new Float32Array(r);p.geometry.setAttribute("instanceColor",new Ct(g,3)),p.geometry.setAttribute("instanceAlpha",new Ct(w,1)),p.geometry.setAttribute("instanceUV",new Ct(x,2)),p.geometry.setAttribute("instanceScale",new Ct(b,1)),p.frustumCulled=!1,Wt.add(p)}let Bt=[];function Ge(){Bt=new Array(A*T).fill(null)}function fe(e,t,i,n,a,c,l,r){if(e<0||e>=T||t<0||t>=A)return;const s=t*T+e,f=Bt[s];f&&f.depth<=i||(Bt[s]={char:n,r:a,g:c,b:l,alpha:r,depth:i})}function se(e,t,i){const n=document.createElement("canvas"),a=n.getContext("2d"),c=[...e].length,l=t*c,r=t;n.width=l,n.height=r,a.fillStyle="#000",a.fillRect(0,0,l,r),a.fillStyle="#fff",a.textAlign="center",a.textBaseline="middle";const s=i||'"SimSun", "STSong", "Songti SC", "Noto Serif SC", serif';a.font=`bold ${Math.floor(t*.85)}px ${s}`,a.fillText(e,l/2,r/2);const g=a.getImageData(0,0,l,r).data,w=[],x=c>1?2:1;for(let b=0;b<r;b+=x)for(let m=0;m<l;m+=x){const S=(b*l+m)*4,v=g[S]/255;v>.1&&w.push({nx:m/l*2-1,ny:b/r*2-1,brightness:v,aspect:c})}return w}function kt(e){const t=Math.floor(e*(Tt.length-1));return Tt[Math.max(0,Math.min(t,Tt.length-1))]}function Xt(e){const i=Math.floor(45+e*170),n=Math.floor(45-e*45);return{r:255,g:i,b:n}}let Gt=[],Yt=!1;Promise.all(O.map(e=>document.fonts.load(`64px ${e}`,"福大吉"))).then(()=>{se("福",64,Lt),Gt=se("大吉",64),Yt=!0,Xe(),N=new Be({onOpen:()=>{Y==="arrival"&&At("draw")},onWish:()=>{At("fireworks")}})});let V=[],mt=0,et=!1,q=-1;function ie(e){if(V=[],q=-1,et=!1,ht(),Array.isArray(e)&&e.length>0){V=e.map(n=>({...n})),et=!0,mt=d;return}if(!Yt)return;const t=Math.min(T,A)*.4*h,i=t*.4;for(const n of Gt){const a=Math.min(1,n.brightness+.08),c=kt(a);if(c===" ")continue;const l=Xt(a);V.push({baseX:n.nx*t*.5*n.aspect,baseY:n.ny*t*.5,origZ:(Math.random()-.5)*i,char:c,fontIdx:Math.random()<.7?Math.floor(Math.random()*O.length):null,r:l.r,g:l.g,b:l.b,alpha:.3+a*.7,lum:a,phase:Math.random()*Math.PI*2})}mt=d}function Ye(e){if(!p)return 0;if(!V.length)return p.count=0,0;const t=Math.min(T,A)*.4*h,i=Math.min(1,(d-mt)/1.2),n=et?1:B(i),a=et?Math.min(1,(d-mt)/.6):1,c=et?0:.5,l=et?1:Math.min(1,Math.max(0,(d-mt-c)/.8)),r=t*.06*l,s=p.geometry.attributes.instanceColor,f=p.geometry.attributes.instanceAlpha,g=p.geometry.attributes.instanceUV,w=p.geometry.attributes.instanceScale,x=s.count,b=Math.min(V.length,x),m=t*.5,S=Math.sin(d*.8)*.3;for(let v=0;v<b;v++){const M=V[v],D=M.origZ*n+Math.sin(d*1.5+M.phase)*r,F=v===q,U=F?-80:0;W.position.set(M.baseX,-M.baseY,-(D+U)),W.updateMatrix(),p.setMatrixAt(v,W.matrix);let rt=M.alpha*Math.max(.2,1.25);rt=Math.min(.8,rt),F&&(rt=1);const R=m>0?M.baseY/m:0,C=Math.max(0,Math.min(1,(R+1)*.5)),J=Math.abs(R-S),z=Math.max(0,1-J*3),j=Math.min(255,Math.floor(y(255,180,C)+z*55)),P=Math.min(255,Math.floor(y(225,130,C)+z*40)),dt=Math.min(255,Math.floor(y(50,10,C)+z*50)),K=y(M.r,j,a)/255,lt=y(M.g,P,a)/255,ft=y(M.b,dt,a)/255;s.setXYZ(v,F?1:K,F?.97:lt,F?.86:ft),f.setX(v,rt);const Q=M.fontIdx!=null&&st[M.char+"|"+M.fontIdx]||st[M.char];Q&&g.setXY(v,Q.u,Q.v);let St=h*1.1;F&&(St*=2.2),w.setX(v,St)}return p.count=b,p.instanceMatrix.needsUpdate=!0,s.needsUpdate=!0,f.needsUpdate=!0,g.needsUpdate=!0,w.needsUpdate=!0,b}const pt=document.createElement("div");Object.assign(pt.style,{position:"fixed",pointerEvents:"none",opacity:"0",transition:"opacity 0.2s ease",background:"rgba(10, 10, 10, 0.92)",border:"1px solid rgba(255, 215, 0, 0.4)",borderRadius:"8px",padding:"14px 18px",textAlign:"center",fontFamily:'"Courier New", "SF Mono", monospace',zIndex:"100",backdropFilter:"blur(8px)",WebkitBackdropFilter:"blur(8px)",boxShadow:"0 0 24px rgba(255, 45, 45, 0.15), 0 0 8px rgba(255, 215, 0, 0.1)",maxWidth:"220px",minWidth:"140px"});pt.innerHTML='<div id="tt-char" style="font-size:36px;color:#FFD700;margin-bottom:6px;text-shadow:0 0 12px rgba(255,215,0,0.5)"></div><div id="tt-phrase" style="font-size:15px;color:#FF2D2D;margin-bottom:4px"></div><div id="tt-english" style="font-size:11px;color:#FFD700;opacity:0.65"></div>';document.body.appendChild(pt);function He(e,t,i){const n=Vt[e];if(!n){ht();return}document.getElementById("tt-char").textContent=e,document.getElementById("tt-phrase").textContent=n.phrase,document.getElementById("tt-english").textContent=n.english;const a=200,c=110;let l=t-a/2,r=i-c-30;l=Math.max(8,Math.min(window.innerWidth-a-8,l)),r<8&&(r=i+40),pt.style.left=l+"px",pt.style.top=r+"px",pt.style.opacity="1"}function ht(){pt.style.opacity="0"}function Ht(e,t){if(V.length===0){q=-1,ht();return}const i=Math.min(T,A)*.4*h,n=Math.min(1,(d-mt)/1.2),a=et?1:B(n),c=et?Math.min(1,(d-mt)/.6):1,l=i*.06*(et?c:a);let r=-1,s=1/0;for(let g=0;g<V.length;g++){const w=V[g];if(!Vt[w.char])continue;const x=w.origZ*a+Math.sin(d*1.5+w.phase)*l,b=ne(w.baseX,w.baseY,x,wt),m=b.screenX-e,S=b.screenY-t,v=m*m+S*S;v<s&&(s=v,r=g)}const f=h*2.5;if(s>f*f){q=-1,ht();return}if(r!==q){q=r;const g=V[r],w=g.origZ*a+Math.sin(d*1.5+g.phase)*l,x=ne(g.baseX,g.baseY,w,wt);He(g.char,x.screenX,x.screenY)}}const ue=[];function _e(){for(let e=0;e<40;e++)ue.push({col:Math.random()*T,row:Math.random()*A,vx:(Math.random()-.5)*.02,vy:(Math.random()-.5)*.02,char:L[Math.floor(Math.random()*L.length)],alpha:.03+Math.random()*.08,phase:Math.random()*Math.PI*2,changeTimer:Math.random()*200})}_e();function _t(e){for(const t of ue){t.col+=t.vx,t.row+=t.vy,t.changeTimer--,t.col<0&&(t.col+=T),t.col>=T&&(t.col-=T),t.row<0&&(t.row+=A),t.row>=A&&(t.row-=A),t.changeTimer<=0&&(t.char=L[Math.floor(Math.random()*L.length)],t.changeTimer=100+Math.random()*200);const i=Math.floor(t.col),n=Math.floor(t.row),a=t.alpha+Math.sin(t.phase+e*1.5)*.02;fe(i,n,999,t.char,255,215,0,Math.max(.01,a))}}function Ue(){o.save(),o.globalAlpha=.03,o.fillStyle="#fff";for(let e=0;e<X.height;e+=4*E)o.fillRect(0,e,X.width,1*E);o.restore()}function $e(){o.save(),o.scale(E,E),o.fillStyle=u.bg,o.fillRect(0,0,window.innerWidth,window.innerHeight);const e=h;o.font=`${e}px ${Lt}, "Courier New", "SF Mono", monospace`,o.textAlign="center",o.textBaseline="middle";for(let t=0;t<A;t++)for(let i=0;i<T;i++){const n=Bt[t*T+i];if(!n)continue;const a=he+i*h+h/2,c=Pt+t*h+h/2;n.alpha>.3?(o.shadowColor=`rgba(${n.r}, ${n.g}, ${n.b}, ${n.alpha*.6})`,o.shadowBlur=h*n.alpha*1.2):(o.shadowColor="transparent",o.shadowBlur=0),o.fillStyle=`rgba(${n.r}, ${n.g}, ${n.b}, ${n.alpha})`,o.fillText(n.char,a,c)}o.shadowBlur=0,o.shadowColor="transparent",o.restore(),Ue()}function Oe(e){o.save(),o.scale(E,E);const i=Math.min(window.innerWidth,window.innerHeight)*.55,n=window.innerWidth/2,a=window.innerHeight/2;o.textAlign="center",o.textBaseline="middle",o.font=`${i}px ${Lt}, serif`,o.globalAlpha=e*.3,o.shadowColor=u.glowGold,o.shadowBlur=i*.15,o.fillStyle=u.glowGold,o.fillText("福",n,a),o.globalAlpha=e,o.shadowColor=u.glowGold,o.shadowBlur=i*.06,o.fillStyle=u.glowGold,o.fillText("福",n,a),o.shadowBlur=0,o.restore()}function k(e,t,i,n,a,c){o.save(),o.scale(E,E);const l=a||Math.max(12,h*1.2),r=c||'"Courier New", "SF Mono", monospace';o.font=`${l}px ${r}`,o.textAlign="center",o.textBaseline="middle",o.fillStyle=i||u.glowGreen,o.globalAlpha=n??.6,o.shadowColor=i||u.glowGreen,o.shadowBlur=l*.4,o.fillText(e,window.innerWidth/2,window.innerHeight*t),o.shadowBlur=0,o.restore()}function qt(){!ot||!Wt||!ct||(ot.render(Wt,ct),o.save(),o.setTransform(1,0,0,1,0,0),o.globalCompositeOperation="lighter",o.drawImage(ot.domElement,0,0),o.restore())}const W=new ve;function ge(e){if(!p)return;if(!e.length){p.count=0;return}const t=p.geometry.attributes.instanceColor,i=p.geometry.attributes.instanceAlpha,n=p.geometry.attributes.instanceUV,a=p.geometry.attributes.instanceScale,c=p.geometry.getAttribute("instanceColor").count,l=Math.min(e.length,c);for(let r=0;r<l;r++){const s=e[r];W.position.set(s.x,-s.y,-s.z),W.updateMatrix(),p.setMatrixAt(r,W.matrix),t.setXYZ(r,s.r/255,s.g/255,s.b/255),i.setX(r,s.alpha);const f=s.fontIdx!=null&&st[s.char+"|"+s.fontIdx]||st[s.char];f&&n.setXY(r,f.u,f.v),a.setX(r,h*(s.size||1))}p.count=l,p.instanceMatrix.needsUpdate=!0,t.needsUpdate=!0,i.needsUpdate=!0,n.needsUpdate=!0,a.needsUpdate=!0,qt()}let Y="arrival",I=0,d=0,me=0,xt=null;function At(e){Y=e,me=d,I=0,e==="draw"&&Je(),e==="fortune"&&(xt&&xt.length>0?(ie(xt),xt=null):ie(),ce()),e==="fireworks"&&(q=-1,ht(),ce())}function je(){_t(d)}function Ze(){const e=Math.min(1,I/1);Oe(e);const t=Math.min(1,I/1.5);k("新年纳福",.15,u.glowGold,t*.8,h*2),k("A Blessing Awaits",.2,u.glowGold,t*.5,h*1.1);const i=Math.min(1,Math.max(0,(I-1.5)/.5)),n=.4+Math.sin(d*3)*.2,a=d%3;let c=0;if(a<.9){const l=1-a/.9;c=-Math.abs(Math.sin(a/.9*Math.PI*3))*.012*l}k("↑  上滑抽签  ↑",.88+c,u.glowGold,i*n,h*1.6),k("Swipe Up to Draw Fortune",.92+c,u.glowGold,i*n,h*1.1)}let vt=[],ut=[],gt=0;const G=u.fuExplodeDelay,pe=u.fuRiseDuration,Ne=u.fuShrinkDuration,Ve=u.fuShrinkEndScale,re=u.fuCameraPullbackDuration,qe=u.fuCameraReturnDuration,_=G+1.2,$=_+1.1,Ot=$+.4;function Je(){if(vt=[],ut=[],gt=0,xt=null,!Yt)return;const e=Math.min(T,A)*.4*h,t=e*.4,i=Gt.map(a=>({x:a.nx*e*.5*a.aspect,y:a.ny*e*.5,z:(Math.random()-.5)*t,brightness:a.brightness})),n=Ft(T/2,A*.22);for(let a=0;a<i.length;a++){const c=i[a],l=Math.random()*Math.PI*2,r=e*(.8+Math.random()*1.2),s=e*(.1+Math.random()*.4);vt.push({x:n.x,y:n.y,z:0,startX:n.x,startY:n.y,startZ:0,scatterX:n.x+Math.cos(l)*r,scatterY:n.y+Math.sin(l)*r*.6+s,scatterZ:(Math.random()-.5)*t*1.6,targetX:c.x,targetY:c.y,targetZ:c.z,char:L[Math.floor(Math.random()*L.length)],scrambleTimer:0,finalChar:kt(c.brightness),brightness:c.brightness,phase:Math.random()*Math.PI*2,fontIdx:Math.random()<.7?Math.floor(Math.random()*O.length):null,active:!1})}}function Ke(){_t(d);const e=I;if(e<G){const n=Math.min(1,e/Math.max(.001,pe)),a=B(n),c=y(A*.5,A*.22,a),l=T/2,r=Ft(l,c);Math.random()<.6&&ut.push({x:r.x+(Math.random()-.5)*h*4,y:r.y+h*(.9+Math.random()*2.2),z:(Math.random()-.5)*h*3,vx:(Math.random()-.5)*h*.08,vy:h*(.08+Math.random()*.12),vz:(Math.random()-.5)*h*.06,char:L[Math.floor(Math.random()*L.length)],life:1,decay:.015+Math.random()*.025})}if(e>=G&&e<G+.15){gt=1-(e-G)/.15;for(const n of vt)n.active=!0}else e>=G+.15&&(gt=0);if(e>=G){for(const n of vt)if(n.active)if(e<_){const a=(e-G)/(_-G),c=1-Math.pow(1-a,2);n.x=y(n.startX,n.scatterX,c),n.y=y(n.startY,n.scatterY,c)+c*h*6,n.z=y(n.startZ,n.scatterZ,c);const l=a*h*.8;n.x+=Math.sin(n.phase+d*4)*l,n.y+=Math.cos(n.phase+d*3)*l,n.z+=Math.sin(n.phase*.7+d*3.2)*l*1.4,n.scrambleTimer-=1,n.scrambleTimer<=0&&(n.char=L[Math.floor(Math.random()*L.length)],n.scrambleTimer=2+Math.random()*3)}else if(e<$){const a=(e-_)/($-_),c=B(a);n.x=y(n.scatterX,n.targetX,c),n.y=y(n.scatterY+h*6,n.targetY,c),n.z=y(n.scatterZ,n.targetZ,c);const l=(1-c)*h*.8;n.x+=Math.sin(n.phase+d*4)*l,n.y+=Math.cos(n.phase+d*3)*l,n.z+=Math.sin(n.phase*.7+d*3.2)*l*1.4,n.scrambleTimer-=1,n.scrambleTimer<=0&&(n.char=a>.4?n.finalChar:L[Math.floor(Math.random()*L.length)],n.scrambleTimer=2+a*12)}else{const a=Math.min(1,(e-$)/Math.max(.001,Ot-$)),c=B(a);n.x=y(n.x,n.targetX,c),n.y=y(n.y,n.targetY,c),n.z=y(n.z,n.targetZ,c),n.char=n.finalChar}}const t=(A*.5+2)*h;let i=0;for(let n=0;n<ut.length;n++){const a=ut[n];a.x+=a.vx,a.y+=a.vy,a.z+=a.vz,a.vx*=.98,a.vz*=.98,a.life-=a.decay,a.life>0&&a.y<t&&(ut[i++]=a)}if(ut.length=i,e>=Ot+.3){const n=Qe();xt=n.length>0?n:null,N&&N.state.wished?At("fireworks"):At("fortune")}}function Qe(){const e=[];for(const t of vt){if(!t.active)continue;const i=Math.min(1,t.brightness+.08),n=t.finalChar||kt(i);if(n===" ")continue;const a=Xt(i);e.push({baseX:t.x,baseY:t.y,origZ:t.targetZ,char:n,fontIdx:t.fontIdx,r:a.r,g:a.g,b:a.b,alpha:.3+i*.7,lum:i,phase:t.phase})}return e}function tn(e){const t=[];for(const a of ut)t.push({x:a.x,y:a.y,z:a.z,char:a.char,r:255,g:Math.floor(190+a.life*65),b:Math.floor(35+a.life*40),alpha:a.life*.68,size:.72+a.life*.35,glow:.9,blur:.8});const n=Math.min(T,A)*.4*h*.06;for(const a of vt){if(!a.active)continue;const c=a.brightness,l=255,r=180+c*75,s=c*50;let f=l,g=r,w=s,x,b=.95+c*.45;if(e<_){const D=1-(e-G)/(_-G),F=Math.sin(d*25+a.phase*3)*.25*D;x=Math.min(1,Math.max(.1,.6+c*.3+F));const U=Math.sin(d*18+a.phase*2)*.3*D;b*=1+U}else if(e<$){const D=(e-_)/($-_),F=Math.sin(d*8+a.phase)*.2*D;x=Math.min(1,Math.max(.2,.6+c*.3+F));const U=Math.sin(d*6+a.phase)*.15*D;b*=1+U}else{const M=Math.min(1,(e-$)/(Ot-$)),D=Math.min(1,c+.08),F=Xt(D);f=y(l,F.r,M),g=y(r,F.g,M),w=y(s,F.b,M);const U=.3+D*.7,rt=Math.min(1,(.5+c*.5)*(1+Math.sin(M*Math.PI)*.3));x=y(rt,U,M),b=y(b,1.1,M)}let m=0;if(e>=$)m=1;else if(e>_){const M=(e-_)/($-_);m=Math.max(0,M-.5)*2}const S=Math.sin(d*1.5+a.phase)*n,v=a.z+S*m;t.push({x:a.x,y:a.y,z:v,char:a.char,fontIdx:a.fontIdx,r:Math.round(f),g:Math.round(g),b:Math.round(w),alpha:x,size:b,glow:.7,blur:.65})}ge(t)}function en(){const e=I;if(tn(e),e<G){const t=Math.min(1,e/Math.max(.001,pe)),i=Math.min(1,e/Math.max(.001,Ne)),n=B(t),a=B(i);o.save(),o.scale(E,E);const r=Math.min(window.innerWidth,window.innerHeight)*.55*y(1,Ve,a),s=window.innerWidth/2,f=window.innerHeight*y(.5,.2,n);o.textAlign="center",o.textBaseline="middle",o.font=`${r}px ${Lt}, serif`;const g=1+t*2.5;o.globalAlpha=Math.min(1,.3*g),o.shadowColor=u.glowGold,o.shadowBlur=r*.2*g,o.fillStyle=u.glowGold,o.fillText("福",s,f),o.globalAlpha=1,o.shadowBlur=r*.08*g,o.fillText("福",s,f),o.shadowBlur=0,o.restore()}if(gt>0){o.save(),o.scale(E,E);const t=window.innerWidth/2,i=window.innerHeight*.22,n=Math.min(window.innerWidth,window.innerHeight)*.4*gt,a=o.createRadialGradient(t,i,0,t,i,n);a.addColorStop(0,`rgba(255, 255, 220, ${gt*.8})`),a.addColorStop(.4,`rgba(255, 215, 0, ${gt*.4})`),a.addColorStop(1,"rgba(255, 215, 0, 0)"),o.fillStyle=a,o.fillRect(0,0,window.innerWidth,window.innerHeight),o.restore()}}function nn(e){const t=Math.min(T,A)*.4,i=T/2,n=A/2;for(const a of Gt){const c=Math.floor(i+a.nx*t*.5*a.aspect),l=Math.floor(n+a.ny*t*.5),r=Math.min(1,a.brightness+.08),s=kt(r);if(s===" ")continue;const f=Xt(r);fe(c,l,0,s,f.r,f.g,f.b,Math.min(1,(.3+r*.7)*e))}}function an(){_t(d),Me(),!yt&&I>6&&d-$t>ke&&($t=d,Dt())}function on(e,t,i,n,a){const l=i*1.5;for(let r=0;r<14;r++){const s=r*137.508,f=(n*2.5+r/14)%1,g=Math.sin(f*Math.PI)*a*.6;if(g<.02)continue;const w=s+d*(1.2+r%3*.4),x=l*(.15+f*.85),b=e+Math.cos(w)*x,m=t+Math.sin(w)*x*.3,S=1+(1-f)*2.5;o.globalAlpha=g,o.fillStyle=u.glowGold,o.shadowColor=u.glowGold,o.shadowBlur=S*5,o.beginPath(),o.arc(b,m,S,0,Math.PI*2),o.fill()}}function sn(e,t){const i=h*5,n=1.3,a=window.innerWidth/2,c=window.innerHeight*.15,l=["大","吉"];if(e>=n){k("大 吉",.15,u.glowGold,.9,h*5,t);return}o.save(),o.scale(E,E),o.font=`${i}px ${t}, serif`,o.textAlign="center",o.textBaseline="middle";const r=o.measureText("大 吉").width,s=o.measureText("大").width,f=o.measureText("吉").width,g=[a-r/2+s/2,a+r/2-f/2];for(let w=0;w<l.length;w++){const x=w*.2,b=n-x-.1,m=Math.max(0,Math.min(1,(e-x)/b));if(m<=0)continue;let S;m<.35?S=y(1.8,.93,B(m/.35)):m<.6?S=y(.93,1.06,B((m-.35)/.25)):S=y(1.06,1,B((m-.6)/.4));const v=Math.min(.9,m*3),M=1+Math.max(0,1-m*1.5)*2.5,D=Math.max(0,1-m*2.5)*i*.1;o.save(),o.translate(g[w],c+D),o.scale(S,S),o.globalAlpha=v*.35*M,o.fillStyle=u.glowGold,o.shadowColor=u.glowGold,o.shadowBlur=i*.25*M,o.fillText(l[w],0,0),o.globalAlpha=v,o.shadowBlur=i*.12,o.fillText(l[w],0,0),o.restore()}o.shadowBlur=0,o.shadowColor="transparent",o.restore()}function rn(e,t,i,n){o.save(),o.scale(E,E);const a=h*5,c=window.innerWidth/2,l=window.innerHeight*.15,r=t*.9,s=["大","吉"];o.font=`${a}px ${i}, serif`,o.textAlign="center",o.textBaseline="middle";const f=o.measureText("大 吉").width,g=o.measureText("大").width,w=o.measureText("吉").width,x=[c-f/2+g/2,c+f/2-w/2];o.font=`${a}px ${n}, serif`;const b=o.measureText("大 吉").width,m=o.measureText("大").width,S=o.measureText("吉").width,v=[c-b/2+m/2,c+b/2-S/2],M=.3,D=.1,F=.7,U=.45,rt=e<.15?e/.15:e>.85?(1-e)/.15:1;if(on(c,l,a,e,r*rt),e<M){const R=e/M;o.font=`${a}px ${i}, serif`,o.textAlign="center",o.textBaseline="middle";for(let C=0;C<s.length;C++){const J=C*.2,z=Math.max(0,Math.min(1,(R-J)/(1-J))),j=Math.sin(d*35+C*2.7)*z*a*.05,P=Math.cos(d*28+C*1.9)*z*a*.035,dt=-z*z*a*.1,K=r*(1-z*z),lt=z*a*.025,ft=x[C]+j,Q=l+P+dt;lt>.5&&(o.globalAlpha=K*.3,o.fillStyle="#FF4444",o.shadowColor="#FF4444",o.shadowBlur=a*.12,o.fillText(s[C],ft-lt,Q),o.fillStyle="#FFEE44",o.shadowColor="#FFEE44",o.fillText(s[C],ft+lt,Q+lt*.3)),o.globalAlpha=K,o.fillStyle=u.glowGold,o.shadowColor=u.glowGold,o.shadowBlur=a*(.15+z*.25),o.fillText(s[C],ft,Q)}}if(e>=D&&e<F){const R=(e-D)/(F-D),C=y(18,3,R*R),J=Math.floor(d*C),z=B(R),j=R<.15?R/.15:R>.7?(1-R)/.3:1;o.font=`${a}px ${R<.5?i:n}, serif`,o.textAlign="center",o.textBaseline="middle";for(let P=0;P<s.length;P++){const dt=L[(J+P*13)%L.length],K=Math.sin(d*5+P*2)*a*.035,lt=Math.cos(d*3.5+P*2.5)*a*.02,ft=y(x[P],v[P],z)+lt,Q=l+K,St=1+Math.sin(d*8+P)*.05;o.save(),o.translate(ft,Q),o.scale(St,St),o.globalAlpha=r*j*.7,o.fillStyle=u.glowGold,o.shadowColor=u.glowGold,o.shadowBlur=a*.2,o.fillText(dt,0,0),o.restore()}}if(e>=U){const R=(e-U)/(1-U);o.font=`${a}px ${n}, serif`,o.textAlign="center",o.textBaseline="middle";for(let C=0;C<s.length;C++){const J=C*.15,z=Math.max(0,Math.min(1,(R-J)/(1-J))),j=B(z);let P;z<.45?P=j/.45*1.1:z<.7?P=y(1.1,.97,B((z-.45)/.25)):P=y(.97,1,B((z-.7)/.3));const dt=(1-j)*a*.12,K=1+Math.sin(z*Math.PI)*.5;o.save(),o.translate(v[C],l+dt),o.scale(P,P),o.globalAlpha=r*j*.35*K,o.fillStyle=u.glowGold,o.shadowColor=u.glowGold,o.shadowBlur=a*.3*K,o.fillText(s[C],0,0),o.globalAlpha=r*j,o.shadowBlur=a*.12,o.fillText(s[C],0,0),o.restore()}}o.shadowBlur=0,o.shadowColor="transparent",o.restore()}function ln(){const e=Ye();nt.length||tt.length||at.length?fn(e):qt();const t=Math.min(1,I/.9);if(yt){const c=(d-yt.startTime)/1.2;c>=1?(yt=null,k("大 吉",.15,u.glowGold,t*.9,h*5,zt())):rn(c,t,yt.oldFont,zt())}else I<1.5?sn(I,zt()):k("大 吉",.15,u.glowGold,t*.9,h*5,zt());const i=Math.min(1,Math.max(0,(I-.5)/.9));if(k("万事如意 · 心想事成",.82,u.glowRed,i*.7,h*1.5),k("May all your wishes come true",.87,u.glowGold,i*.5,h*1),!document.querySelector(".envelope-panel.active")&&I>2.5&&N&&!N.state.wished){const a=Math.min(1,(I-2.5)/.5),c=.4+Math.sin(d*3)*.2;k("↑  上滑许愿  ↑",.94,u.glowGold,a*c,h*1.2),k("Swipe Up to Make a Wish",.97,u.glowGold,a*c,h*.9)}}const le=[{chars:"福禄寿喜财",r:255,g:45,b:45},{chars:"财富贵发金玉宝余丰盛利旺",r:255,g:215,b:0},{chars:"安康宁泰和平顺健",r:0,g:255,b:159},{chars:"喜乐欢庆禧祺嘉春",r:255,g:120,b:80},{chars:"德善仁义忠信孝慧恩",r:255,g:200,b:50},{chars:"爱合圆满美馨雅",r:255,g:130,b:180},{chars:"吉祥瑞如意祝运",r:180,g:255,b:80},{chars:"龙凤麟鹤华",r:255,g:180,b:50},{chars:"成升登高",r:80,g:220,b:255}],nt=[],tt=[],at=[];let Et=0,Jt=0;function we(){const e=le[Math.floor(Math.random()*le.length)],t=T*(.15+Math.random()*.7),i=t+(Math.random()-.5)*T*.12,n=Ft(t,A+2),a=Ft(i,A*(.1+Math.random()*.3)),c=(Math.random()-.5)*h*8;nt.push({x:n.x,y:n.y,z:c,startX:n.x,startY:n.y,startZ:c,targetX:a.x,targetY:a.y,targetZ:(Math.random()-.5)*h*12,launchTime:d,duration:u.shellRiseDuration*(.85+Math.random()*.3),cat:e}),Jt++}function cn(e){const t=25+Math.floor(Math.random()*35),{chars:i,r:n,g:a,b:c}=e.cat;for(let l=0;l<t;l++){const r=Math.PI*2*l/t+(Math.random()-.5)*.4,s=h*(.06+Math.random()*.1);at.push({x:e.x,y:e.y,z:e.z,vx:Math.cos(r)*s,vy:Math.sin(r)*s-h*.06,vz:(Math.random()-.5)*s*.5,char:i[Math.floor(Math.random()*i.length)],r:n,g:a,b:c,life:.6+Math.random()*.3,decay:.008+Math.random()*.008,gravity:h*(.001+Math.random()*.001),drag:.985,trailSegs:[],lastTrailTime:d})}}function ce(){nt.length=0,tt.length=0,at.length=0,Et=0,Jt=0;for(let e=0;e<2;e++)we()}function Me(){Et--,Et<=0&&(we(),Et=Jt<3?40+Math.random()*30:70+Math.random()*80);const e=T*h*.5,t=A*h*.5;let i=0;for(let r=0;r<nt.length;r++){const s=nt[r],f=(d-s.launchTime)/s.duration,g=1-Math.pow(1-Math.min(f,1),2);s.x=y(s.startX,s.targetX,g),s.y=y(s.startY,s.targetY,g),s.z=y(s.startZ,s.targetZ,g);const w=Math.max(1,Math.floor((1-g)*2.8));for(let x=0;x<w;x++)tt.push({x:s.x+(Math.random()-.5)*h*.35,y:s.y+h*(.12+Math.random()*.32),z:s.z+(Math.random()-.5)*h*.6,vx:(Math.random()-.5)*h*.03,vy:h*(.07+Math.random()*.04),vz:(Math.random()-.5)*h*.03,char:"·",r:s.cat.r,g:s.cat.g,b:s.cat.b,life:.35+Math.random()*.45,decay:.03+Math.random()*.04});f>=1?cn(s):nt[i++]=s}nt.length=i;let n=0;for(let r=0;r<tt.length;r++){const s=tt[r];s.x+=s.vx,s.y+=s.vy,s.z+=s.vz,s.vx*=.95,s.vz*=.95,s.life-=s.decay,s.life>0&&s.y<=t+h*3&&(tt[n++]=s)}tt.length=n;const a=.06,c=14;let l=0;for(let r=0;r<at.length;r++){const s=at[r];s.vx*=s.drag,s.vy*=s.drag,s.vz*=s.drag,s.vy+=s.gravity,s.x+=s.vx,s.y+=s.vy,s.z+=s.vz,s.life-=s.decay,d-s.lastTrailTime>=a&&s.life>.05&&(s.trailSegs.push({x:s.x,y:s.y,z:s.z}),s.lastTrailTime=d,s.trailSegs.length>c&&s.trailSegs.shift()),s.life>0&&s.y<=t+h*6&&s.x>=-e-h*8&&s.x<=e+h*8&&s.z>=-wt*.9&&s.z<=wt*1.5&&(at[l++]=s)}at.length=l}function hn(){_t(d),nn(.15+Math.sin(d*.8)*.05),Me()}function dn(){const e=[];for(const t of nt)e.push({x:t.x,y:t.y,z:t.z,char:"·",r:t.cat.r,g:t.cat.g,b:t.cat.b,alpha:.9,size:1,glow:1,blur:.9});for(const t of tt)e.push({x:t.x,y:t.y,z:t.z,char:t.char,r:t.r,g:t.g,b:t.b,alpha:t.life*.7,size:.7+t.life*.3,glow:.9,blur:.85});for(const t of at){const i=Math.max(.05,t.life*t.life);e.push({x:t.x,y:t.y,z:t.z,char:t.char,r:t.r,g:t.g,b:t.b,alpha:i,size:.92+i*.5,glow:.65,blur:.62});const n=t.trailSegs.length;for(let a=0;a<n;a++){const c=t.trailSegs[a],l=n>1?a/(n-1):1,r=i*(.2+l*.6);e.push({x:c.x,y:c.y,z:c.z,char:t.char,r:t.r,g:t.g,b:t.b,alpha:r,size:.6+l*.35,glow:.5,blur:.5})}}ge(e)}function fn(e){if(!p)return;const t=p.geometry.attributes.instanceColor,i=p.geometry.attributes.instanceAlpha,n=p.geometry.attributes.instanceUV,a=p.geometry.attributes.instanceScale,c=t.count;let l=e;for(const r of nt){if(l>=c)break;W.position.set(r.x,-r.y,-r.z),W.updateMatrix(),p.setMatrixAt(l,W.matrix),t.setXYZ(l,r.cat.r/255,r.cat.g/255,r.cat.b/255),i.setX(l,.9);const s=st["·"];s&&n.setXY(l,s.u,s.v),a.setX(l,h),l++}for(const r of tt){if(l>=c)break;W.position.set(r.x,-r.y,-r.z),W.updateMatrix(),p.setMatrixAt(l,W.matrix),t.setXYZ(l,r.r/255,r.g/255,r.b/255),i.setX(l,r.life*.7);const s=st[r.char];s&&n.setXY(l,s.u,s.v),a.setX(l,h*(.7+r.life*.3)),l++}for(const r of at){if(l>=c)break;const s=Math.max(.05,r.life*r.life);W.position.set(r.x,-r.y,-r.z),W.updateMatrix(),p.setMatrixAt(l,W.matrix),t.setXYZ(l,r.r/255,r.g/255,r.b/255),i.setX(l,s);const f=st[r.char];f&&n.setXY(l,f.u,f.v),a.setX(l,h*(.92+s*.5)),l++;const g=r.trailSegs.length;for(let w=0;w<g&&!(l>=c);w++){const x=r.trailSegs[w],b=g>1?w/(g-1):1,m=s*(.2+b*.6),S=h*(.6+b*.35);W.position.set(x.x,-x.y,-x.z),W.updateMatrix(),p.setMatrixAt(l,W.matrix),t.setXYZ(l,r.r/255,r.g/255,r.b/255),i.setX(l,m),f&&n.setXY(l,f.u,f.v),a.setX(l,S),l++}}p.count=l,p.instanceMatrix.needsUpdate=!0,t.needsUpdate=!0,i.needsUpdate=!0,n.needsUpdate=!0,a.needsUpdate=!0,qt()}function un(){dn();const e=Math.min(1,I/1.5);if(k("恭喜发财",.08,u.glowGold,e*.7,h*2),k("Prosperity & Fortune",.13,u.glowGold,e*.4,h*1),!document.querySelector(".envelope-panel.active")&&I>3){const i=Math.min(1,(I-3)/.5),n=.3+Math.sin(d*3)*.2;k("↑  查看详情  ↑",.94,u.glowGold,i*n,h*1),k("Swipe Up to View Status",.97,u.glowGold,i*n,h*.8)}}let Kt=0,Qt=0,ye=0,jt=!1,it=null,Zt=0,Nt=0;X.addEventListener("touchstart",e=>{const t=e.touches[0];Kt=t.clientX,Qt=t.clientY,Zt=t.clientX,Nt=t.clientY,ye=performance.now(),jt=!1,it&&clearTimeout(it),Y==="fortune"&&(it=setTimeout(()=>{jt||Ht(Zt,Nt)},250))},{passive:!0});X.addEventListener("touchmove",e=>{const t=e.touches[0];Zt=t.clientX,Nt=t.clientY,(Math.abs(t.clientX-Kt)>10||Math.abs(t.clientY-Qt)>10)&&(jt=!0,it&&(clearTimeout(it),it=null)),Y==="fortune"&&Ht(t.clientX,t.clientY)},{passive:!0});X.addEventListener("touchend",e=>{it&&(clearTimeout(it),it=null),q=-1,ht();const t=e.changedTouches[0].clientX-Kt,i=Qt-e.changedTouches[0].clientY,n=performance.now()-ye;Y==="fortune"&&Math.abs(t)>50&&Math.abs(t)>Math.abs(i)&&n<500?Dt():i>50&&n<500&&Ut()},{passive:!0});X.addEventListener("mousemove",e=>{Y==="fortune"&&Rt&&Ht(e.clientX,e.clientY)});X.addEventListener("mouseleave",()=>{q=-1,ht()});let xe=0,Rt=!1,bt=null;X.addEventListener("mousedown",e=>{xe=e.clientY,Rt=!0,bt&&clearTimeout(bt),Y==="fortune"&&(bt=setTimeout(()=>{Ht(e.clientX,e.clientY)},250))});X.addEventListener("mouseup",e=>{bt&&(clearTimeout(bt),bt=null),q=-1,ht(),Rt&&xe-e.clientY>50&&Ut(),Rt=!1});X.addEventListener("wheel",e=>{e.deltaY<-30&&Ut()},{passive:!0});window.addEventListener("keydown",e=>{(e.code==="Space"||e.code==="ArrowUp")&&(e.preventDefault(),Ut()),Y==="fortune"&&(e.code==="ArrowLeft"&&(e.preventDefault(),Dt()),e.code==="ArrowRight"&&(e.preventDefault(),Dt()))});function Ut(){Y==="arrival"&&Yt?At("draw"):Y==="fortune"?N&&!N.state.wished&&N.showWishInput():Y==="fireworks"&&N&&N.showPanel("result")}const gn=performance.now();function be(e){switch(d=(e-gn)/1e3,I=d-me,Ge(),Y){case"arrival":je();break;case"draw":Ke();break;case"fortune":an();break;case"fireworks":hn();break}let t=0;if(Y==="draw"){if(I<G)if(I<re){const i=Math.min(1,I/Math.max(.001,re));t=-B(i)*h*3}else t=-h*3;else{const i=Math.min(1,(I-G)/Math.max(.001,qe));t=-(1-B(i))*h*3}Pt+=t}switch($e(),t!==0&&(Pt-=t),p&&(p.count=0),Y){case"arrival":Ze();break;case"draw":en();break;case"fortune":ln();break;case"fireworks":un();break}requestAnimationFrame(be)}requestAnimationFrame(be);
